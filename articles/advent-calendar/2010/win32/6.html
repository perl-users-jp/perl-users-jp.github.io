<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>CPANモジュールをWindowsのみで作成する方法 - Articles Advent Calendar 2010 Win32</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>CPANモジュールをWindowsのみで作成する方法</h1>
        tag

        <p>こんにちは今年CPAN Authorの端くれになった<a href="http://twitter.com/songmu">Songmu</a>です。私みたいなヤツがCPANにモジュールを上げてしまってDisられないかビクビクしております。</p><p>CPANモジュールをWindows上で作っていたら色々無駄に苦労してしまったので、その辺の話を、Windows上でPerl開発する上でのTipsも含めて書いてみたいと思います。</p>

<ul>
<li>Cygwinは甘ぇ</li>
<li>VMは邪道</li>
<li>コマンドプロンプトとGUIで頑張るのが真のWin32Perl使い</li>
<li>(ごめんなさいごめんなさい)</li>
</ul><p>では行ってみたいと思います。</p>

<div class="section">
    <h3>改行コード編</h3>
    <p>ソースコードの改行コードは基本的にはLFに揃えたいところです。ただ、Windowsには様々なところでCRLFがついてまわりますが、</p><p>注意。いきなりバッドノウハウです。</p><p>ActivePerlでは、標準の改行コードがCRLFになっています。また、読み込んだファイルの改行コードがCRLFでもLFでもよろしく計らってくれるようになっています。</p><p><strong>そして文字列中の"\n"を勝手にCRLFに変換して出力してしまいます</strong>(binmode ':raw'にしてから出力すれば良いんですが)</p><p>実際module-setup等のコード自動出力系のモジュールを使うと困ってしまいます。</p><p>その妙な気遣いが空回りしている辺り、Perlが変なWindowsの毒気に中てられてしまっていてよろしくありません。全部LFに統一してしまいましょう。</p><p>方法は簡単です。環境変数PERLIOに":unix:perlio"を指定します。</p>

    <pre class="code prettyprint">C:\&gt;set PERLIO=:unix:perlio</pre>

<div class="section">
    <h5>軽く解説</h5>
    <p>PERLIOはデフォルトのPerlIOを指定できる環境変数です。PerlIOとは</p>

    <pre class="code prettyprint">open $fh,&#39;&lt;:encoding(***)&#39;,&#39;file&#39;;</pre>
<p>で"***"の部分に指定するやつです。(正確には違いますが)</p><p>UNIXでは:unix:perlioまたは:stdioがデフォルト、Win32では:unix:crlfがデフォルトで将来的には:win32がデフォルトになる予定のようです。</p><p>参考URL  <br />
<a href="http://perldoc.perl.org/PerlIO.html">http://perldoc.perl.org/PerlIO.html</a>  <br />
<a href="http://d.hatena.ne.jp/pasela/20090909/perlio">http://d.hatena.ne.jp/pasela/20090909/perlio</a>  <br />
<a href="http://d.hatena.ne.jp/gfx/20080723/1216782993">http://d.hatena.ne.jp/gfx/20080723/1216782993</a>  </p><p></p>

</div>
<div class="section">
    <h4>注意</h4>
    <p>かなりバッドノウハウに近い方法なので、場合によってはモジュールのテストが通らなくなったり(テスト内で改行コードを含んだ文字列を比較しているような場合等)、動きがおかしくなったりするかもしれません。</p><p>ちなみにchompで\nしか撥ねてくれなくなるので注意。改行コードがCRLFのファイルを読み込んでchompすると、行の末尾に"\r"が残ってしまいます。</p>

</div>
<div class="section">
    <h4>gitの改行コード問題</h4>
    <p>なんかWindowsのgitにも勝手に、改行コードをLFからCRLFに変えてしまうような設定があり、それがデフォルトだったりするのでそんなものはoffにしてしまいましょう。</p>

    <pre class="code prettyprint">git config --global core.autoCRLF false</pre>

</div>
</div>
<div class="section">
    <h3>モジュールの雛形の作成</h3>
    <p>モジュールの雛形はModule::Setupで作っています。なんか多分環境変数をいじったせいで、生成されたファイルの中に生のCRが残ってしまうことなんかがありましたが、その辺は適宜手で修正しました。</p><p>また、Makeが必要なので、NMAKE.exeを導入しておきましょう。</p>

</div>
<div class="section">
    <h3>モジュールを書く</h3>
    <p>省略</p>

</div>
<div class="section">
    <h3>ShipIt! (?)</h3>
    <p>ごめんなさい。ShipIt使ったことありません。</p><p>さぁ、make distしたモジュールをCPANにすぐにアップロード！…してはいけません。</p><p>意気揚々とCPANにモジュールをアップロードすると、すぐにこんなメールが自動送信されてきます。</p>

<blockquote >
    <p>Subject: Failed: PAUSE indexer report SONGMU/Math-CheckDigits-0.01.tar.gz</p><p>The following report has been written by the PAUSE namespace indexer.<br />
Please contact modules@perl.org if there are any open questions.<br />
 Id</p><p>    (..省略..)</p><p>The distribution contains the following world writable directories or<br />
files and is therefore considered a security breach and as such not<br />
being indexed: Math-CheckDigits-0.01/ Math-CheckDigits-0.01/inc/Module/<br />
    (..省略..)<br />
Math-CheckDigits-0.01/xt/03_pod.t Math-CheckDigits-0.01/xt/perlcriticrc<br />
. See also <a href="http://use.perl.org/~bart/journal/38127">http://use.perl.org/~bart/journal/38127</a></p><br />
<p>For your convenience PAUSE has tried to write a new tarball with all the<br />
world-writable bits removed. The file is available for a *very* short<br />
period at<br />
'<a href="ftp://pause.perl.org/incoming/Math-CheckDigits-0.01-withoutworldwriteables.tar.gz'.">ftp://pause.perl.org/incoming/Math-CheckDigits-0.01-withoutworldwriteables.tar.gz'.</a><br />
In case you use this file, please verify carefully whether it is a<br />
suitable replacement.</p><br />
<p>__END__</p>

    
</blockquote><p>超訳：</p>

<blockquote >
    <p>書き込み権限が付与されているファイルを送ってくるんじゃねーよ。<a href="http://use.perl.org/~bart/journal/38127">http://use.perl.org/~bart/journal/38127</a> をみて勉強しな。</p><p>書き込み権限落としたtar.gzを  <br />
　<a href="ftp://pause.perl.org/incoming/***-withoutworldwriteables.tar.gz">ftp://pause.perl.org/incoming/***-withoutworldwriteables.tar.gz</a>  <br />
に置いておいてあげたから、使いたかったら気をつけて使ってね。ちょっとの間だけだけどね。べっ、別にあなたのためじゃないんだからね！</p>

    
</blockquote><p>つまり、Windowsにはパーミッションの考え方がなく、作成したファイルはパーミッションが0777扱いになってしまうんですね。</p><p>書き込み権限を落としたtar.gzを自動で生成してくれるようですが、それを毎回わざわざ使うのもかっこ悪いしマナーとしても良くなさそうなので、ローカルで何とかしたいところです。</p><p>で、メールに記載されている <a href="http://use.perl.org/~bart/journal/38127">http://use.perl.org/~bart/journal/38127</a> を見に行くと、詳しい説明が書いてあります。以下のように記述されているところがあり、hereにリンクが張ってあります。</p>

<blockquote >
    <p>And that's what I did here. I've used Archive::Tar,</p>

    
</blockquote><p>リンク先のURLは以下で、そこになんとtar.gzの書き込み権限を落としてくれるスクリプトのコードが置かれています。</p><p><a href="http://perlmonks.org/index.pl?node_id=731935">http://perlmonks.org/index.pl?node_id=731935</a></p><p>私はこれを、tarfix4cpan.pl という名前で保存して、以下のようにして、tar.gzの書き込み権限をクリアしています。</p>

    <pre class="code prettyprint">tarfix4cpan.pl -i ***.tar.gz</pre>
<p>このメールが自動で送られてくるのには感動しました。エラーに対して自動で解決方法が送られるようになってるってのが凄い、CPAN凄い。まあ、同じ過ちを犯した人も多かったんでしょうね。</p><p>てことで、Windows上でCPANモジュールを作った流れをざっくり書いてみましたが、多分こんなに頑張らずにVMWareとかMacとかを使うのが良いと思います。</p><p>さて、明日はどなたが書くのでしょうか。</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
