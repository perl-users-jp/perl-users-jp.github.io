<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="tomi-ru">
        <title>Text::MeCab（日本語変換系Acmeモジュールを支える偉大なモジュール） - Articles Advent Calendar 2010 Acme</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Text::MeCab（日本語変換系Acmeモジュールを支える偉大なモジュール）</h1>

        <p>こんにちは、とみた<a href="http://twitter.com/tomita">トミール</a>です。</p><p><a href="http://deps.cpantesters.org/depended-on-by.pl?dist=Text-MeCab">Text::MeCabに依存しているモジュールリスト</a>がAcmeばかり、しかもかなりぼくのモジュールじゃないかｗと気づいたので、この偉大な日本語変換系Acmeモジュールを支えるText::MeCab様についてあらためて使い方を紹介してみます。</p><br />
<p><h3>mecabとは</h3></p><p><a href="http://mecab.sourceforge.net/">mecab</a>とは、日本語形態素解析を高速に、未知語もいい感じで補足してくれるよくできたライブラリです。作者の方はGoogleにいて（今も、たぶん。）<a href="http://googlejapan.blogspot.com/2008/04/inside-google.html">エイプリルフールに日本語お笑い系機能を出したり</a>しています（それが本職じゃないと思いますけど）。</p><p>インストールすると入るmecabコマンドから、コマンドラインではこんな感じに使います。mecabを起動してから、文を入力してエンターです。</p>

    <pre class="code prettyprint">$ mecab
わたしはたわしをわたしました。
わたし  名詞,代名詞,一般,*,*,*,わたし,ワタシ,ワタシ
は      助詞,係助詞,*,*,*,*,は,ハ,ワ
たわし  名詞,一般,*,*,*,*,たわし,タワシ,タワシ
を      助詞,格助詞,一般,*,*,*,を,ヲ,ヲ
わたし  動詞,自立,*,*,五段・サ行,連用形,わたす,ワタシ,ワタシ
まし    助動詞,*,*,*,特殊・マス,連用形,ます,マシ,マシ
た      助動詞,*,*,*,特殊・タ,基本形,た,タ,タ
。      記号,句点,*,*,*,*,。,。,。
EOS</pre>
<p>たとえば、「わたし」を「それがし」に変換したいとした場合、普通に</p>

    <pre class="code prettyprint">$text =~ s/わたし/それがし/g;</pre>
<p>すると、「わたします」みたいな別の単語にも影響してしまうので、形態素に区切って、その上で処理をしたりできるわけです。すばらしい。</p><p>ちなみにYahooのウェブサービスでもさいきん形態素のやつありますね。あれの方がウェブサービスを使い慣れている場合（WebService::Simpleとかで）は楽かもしれません。</p><p>ただ、毎回ネットワーク越しにリクエストが走るという厳しさと、あと後述するmecabのみの機能があるため、ネタ日本語変換で形態素解析使うならText::MeCabは必須でしょう。</p><br />
<p><h3>Text::MeCabとは</h3></p><p><a href="http://search.cpan.org/perldoc?Text::MeCab">Text::MeCab</a>はmecabのPerlインターフェースです。mecabのページでMeCab.pmっていうperlモジュールも提供されているのですが、それはいかにもSWIGで自動生成しました！っていうインターフェースなので、Text::MeCabの方がいいです。</p><p>mecabを先にインストールしておく必要があります。<a href="http://search.cpan.org/perldoc?Alien::MeCab">Alien::MeCab</a>っていうCPANの機能を利用してインストールできるパッケージもありますが、mecabの利用には本体だけじゃなくて辞書も必要です。辞書はAlien::MeCabについてこないので、普通にmecabのページに書いている方法で本体と辞書をインストールするといいです。辞書はutf-8でコンパイルするのが好みです。</p><p>Text::MeCabは、前はDevel::CheckLibが事前に入ってないと入らない、という話がありましたが昨日のアップデートで解消された模様です。あと、LD_LIBRARY_PATH環境変数が設定されてなくてこける、ということがありましたがぼくだけかもしれません。</p>

    <pre class="code prettyprint">export LD_LIBRARY_PATH=/usr/local/lib</pre>
<p><br />
<h3>使いかたとtips 基本編</h3></p><p>「わたし」を「それがし」にするならこんな感じでしょうかね。</p>

    <pre class="code prettyprint lang-perl">use utf8;
use Encode;
use Text::MeCab;

my $parser = Text::MeCab-&gt;new();
my $encoding = Encode::find_encoding( Text::MeCab::ENCODING ); # ポイントその１

my $input = &#34;わたしはたわしをわたしました。&#34;;

my @result;
for my $text (split /(\s+)/, $input) { # ポイントその２
    if ($text =~ /\s/) {
        push @result, $text;
        next;
    }

    # ポイントその３
    foreach (
        my $node = $parser-&gt;parse($encoding-&gt;encode($text));
        $node;
        $node = $node-&gt;next
    ) {
        # ポイントその４
        next if $node-&gt;stat =~ /[23]/; # skip MECAB_(BOS|EOS)_NODE
        
        my $surface = $encoding-&gt;decode($node-&gt;surface);
        my $feature = $encoding-&gt;decode($node-&gt;feature);
        my @feature = split &#39;,&#39;, $feature;
        
        if ($surface eq &#39;わたし&#39; and $feature[0] eq &#39;名詞&#39;) {
            push @result, &#39;それがし&#39;;
        } else {
            push @result, $surface;
        }
    }
}

print join &#39;&#39;, @result;</pre>
<p><br />
ポイントその１</p><p>Text::MeCabは現状バイト列を受け取ってバイト列を返すため、parse()にはencodeしたものを、結果を受け取るsurface()やfeature()の結果はdecodeしてやる必要があります。Text::MeCab::ENCODINGで辞書のエンコーディングが取れるので、それを元にencode/decodeすればＯＫです。</p><p>これはオーバーヘッドを考慮してということなので、気が向いたらText::MeCabやYahoo形態素APIを同じAPIで使えるLingua::JA::MAParserみたいなのを作ってそれがうまいことラップするような感じにしようかなあとか思ってます。ネタモジュール作りたいだけなので文句言いません。どんなインターフェースでも喜んで使います。</p><p>ポイントその２</p><p>二重にforを回しているように見えるのですが、mecabは改行を文の区切りとして判断するため、改行が含まれているテキストを内側だけのループでまわして、surfaceをくっつけると改行が消えてしまいます。それで、事前にwhitespaceで区切って、whitespace以外のものをmecabに渡しています。ネタモジュール作りたいだけなので文句言いません。どんなインターフェースでも喜んで使います。</p><p>ポイントその３</p><p>Text::MeCabのparseは各形態素ごとにText::MeCab::Nodeオブジェクトを返します。nextで次の形態素に進み、最後にfalseを返すので、Cスタイルのforでループするのが良く使われます。</p><p>ポイントその４</p><p>Text::MeCab::Nodeオブジェクトのメソッドでよく使うのはこんなかんじです。</p>

    <pre class="code prettyprint lang-perl">$node-&gt;stat;    # 0 MECAB_NOR_NODE ふつうのノード
                # 1 MECAB_UNK_NODE 未知語ノード（未知語ONで使った場合）
                #         ^ unknownの意味であってウンコの意味ではない
                # 2 MECAB_BOS_NODE 最初フラグ（surfaceはない）
                # 3 MECAB_EOS_NODE 最後フラグ（surfaceはない）
$node-&gt;surface; # 「わたし」とか、もともとの文を区切った断片
$node-&gt;feature; # 「名詞,代名詞,一般,*,*,*,わたし,ワタシ,ワタシ」みたいな要素詳細</pre>
<p></p><p><h3>使いかたとtips 発展編</h3></p><p>userdicについて！</p><p>これが言いたかったのですが、mecabのuserdicオプションは強力です。日本語変換ネタモジュール界では伝家の宝刀と呼ばれています（[要出典]）。</p><p>これは、もともとの辞書にプラスしてカスタム辞書を加味して形態素解析させるというものです。</p><p>たとえば、以下のようなcsvをユーザー辞書ファイル user.csvとして用意します。</p>

    <pre class="code prettyprint">わたし,1306,1306,1000,名詞,代名詞,一般,*,*,*,わたし,ワタシ,ワタシ,それがし</pre>
<p>これをこんな感じでコンパイルします。</p>

    <pre class="code prettyprint">/usr/local/libexec/mecab/mecab-dict-index \
    -d /usr/local/lib/mecab/dic/ipadic \ # mecabで使ってる辞書のディレクトリ
    -f utf-8 \    # ユーザー辞書ファイルの文字コード
    -t utf-8 \    # ipadic辞書の文字コード
    -u user.dic \ # コンパイルした辞書の出力先ファイル名
    user.csv      # ユーザー辞書ファイル</pre>
<p>mecabからはこんな風に使います。</p>

    <pre class="code prettyprint">$ mecab --userdic=user.dic
わたしはたわしをわたしました。
わたし  名詞,代名詞,一般,*,*,*,わたし,ワタシ,ワタシ,それがし
は      助詞,係助詞,*,*,*,*,は,ハ,ワ
たわし  名詞,一般,*,*,*,*,たわし,タワシ,タワシ
を      助詞,格助詞,一般,*,*,*,を,ヲ,ヲ
わたし  動詞,自立,*,*,五段・サ行,連用形,わたす,ワタシ,ワタシ
まし    助動詞,*,*,*,特殊・マス,連用形,ます,マシ,マシ
た      助動詞,*,*,*,特殊・タ,基本形,た,タ,タ
。      記号,句点,*,*,*,*,。,。,。
EOS</pre>
<p>「わたし」の要素に、末尾に「それがし」が付いている＝「わたし」の要素がもともとのipadicにある要素ではなく、ユーザー辞書の要素に入れ替えられているのがわかります。</p><p>このuserdic機能を利用し、Text::MeCabのオプションでそれを指定して、</p>

    <pre class="code prettyprint">my $parser = Text::MeCab-&gt;new({
    userdic =&gt; &#39;user.dic&#39;,
});</pre>
<p>以下のように、もしその追加要素があればそれに入れ替える、みたいな使い方ができます。Acme::Samuraiの単語入れ替えはほぼこれを使っています。</p>

    <pre class="code prettyprint">    my $feature = $encoding-&gt;decode($node-&gt;feature);
    my @feature = split &#39;,&#39;, $feature;
    
    push @result, $feature[9] || $surface;</pre>
<p><br />
あと既存の要素を入れ替える以外に、新たに要素を追加することもできます。たぶんこっちが本来のuserdicの使い方と思われます。Acme::Ikamusumeでは、HTMLタグを記号と判断してほしかったので（ipadic辞書デフォルトのままだと、未知語として名詞と判断されてします）以下のような追加をしています。</p>

    <pre class="code prettyprint">&lt;,6,6,1000,記号,一般（GESO可）,*,*,*,*,&lt;,&lt;,&lt;
&gt;,6,6,1000,記号,一般（GESO可）,*,*,*,*,&gt;,&gt;,&gt;
&lt;/,6,6,1000,記号,一般（GESO可）,*,*,*,*,&lt;/,&lt;/,&lt;/</pre>
<p>一般（GESO可）っていう分類は、記号は記号でも直前要素にGESOルールを適用するかどうか、っていう勝手要素としてつくったものです。</p><p>オリジナル辞書の作り方は、公式ページの資料と、実際のipadicの中のcsvを研究するといいです。</p><br />
<p>mecab作者の工藤さん、Text::MeCab作者の牧さん、おかげでだいぶ楽してネタモジュールを作れています。ありがとうございます。</p>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
