<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="piarra">
        <meta name="author" content="piarra">
        <title>WWW::SalesforceでChatterのタイムラインを取得する - Articles Advent Calendar 2010 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>WWW::SalesforceでChatterのタイムラインを取得する</h1>

        <p>こんばんは。<br />
md5が暗算できる人という噂が流れている(という噂を流している)<a href="http://twitter.com/piarrakun">piarra</a>です。</p><p>東京も寒くなってきたので、少しホットなネタとして、今日はChatterにフォーカスしてみたいと思います。</p><p><a href="http://www.salesforce.com/jp/chatter/">Chatter</a>はSalesforce.com社により提供されているforce.comというクラウド上で展開されているコミュニケーションツールで、簡単にいうと企業内Twitterのようなものです。<br />
Twitterとの違いは、</p>

<ul>
<li>企業・チーム内でのコミュニケーションのために閉じたものであること</li>
<li>ファイル等の添付とTL上でのプレビューが可能であること</li>
<li>人だけでなく、案件やオブジェクトがフォローできること</li>
<li>投稿の文字数制限がないこと(厳密にはデータ型の限界があるかと思います)</li>
</ul><p>などがあります。</p><p>使ってみたいけれどSalesforceは有料でしょ？という質問があるかもしれませんが、実は、force.comのFree Editionを使えば、100名以下の組織であれば、無料でChatterを使うことができます。(2010年12月現在)</p><p>Chatterを使ってみたいという方は、<a href="http://www.salesforce.com/jp/platform/pricing-editions.jsp?d=70130000000FlcL&internal=true">&#x3053;&#x3061;&#x3089;</a>よりforce.comのFree Editionにサインアップしてみてください。</p><p>そんなチーム内のコミュニケーションを豊かにするChatterですが、少し残念なこととして、TwitterライクなAPIが用意されておらず、クライアントを作ることが困難なことがあげられます。</p><p>そこで、今日はCPANモジュールWWW::Salesforceを用いて、Chatterのフィードを取得する方法をまとめてみました。</p><p>以下、サンプルプログラムです。</p>

    <pre class="code lang-perl">use common::sense;
use Data::Dumper;
use WWW::Salesforce::Simple;
$WWW::Salesforce::SF_PROXY = &#39;https://www.salesforce.com/services/Soap/u/20.0&#39;;

my $userid         = &#39;*****&#39;;
my $password       = &#39;*****&#39;;
my $security_token = &#39;***********&#39;;
my $chatter = WWW::Salesforce::Simple-&gt;new(
    &#39;username&#39; =&gt; $userid,
    &#39;password&#39; =&gt; $password . $security_token,
);
my $query = &#34;SELECT Id, Type, CreatedDate, CreatedById, CreatedBy.Name, 
    ParentId, Parent.Name, FeedPostId, FeedPost.Body, 
    FeedPost.Title, FeedPost.LinkUrl,  
    (SELECT Id, FieldName, OldValue, NewValue FROM FeedTrackedChanges), 
    (SELECT Id, CreatedDate, CreatedById, CreatedBy.Name, CommentBody 
    FROM FeedComments ORDER BY CreatedDate DESC)  
    FROM NewsFeed ORDER BY CreatedDate DESC, Id DESC LIMIT 10&#34;;
my $res = $chatter-&gt;do_query( $query, 2000 );
print Dumper($res);</pre>
<p>$userid, $passwordにはログインの際のIDとパスワードを指定します。<br />
$security_tokenにはAPI用のセキュリティトークンを指定します。<br />
セキュリティトークンは、force.comの設定画面でリセットすることができ、リセットするとメールでトークンが通知されます。</p><p>$queryとして指定しているのはSOQLというforce.comプラットフォームでの独自のSQLの実装で、<br />
Chatterだけでなく、クラウド上の様々なデータを同様に抽出することができます。<br />
※SOQLの先頭にはスペースを含めることができませんので注意が必要です。</p><p>ChatterのデータはNewsFeed, FeedCommentsというテーブル上に含まれていますので、それをSELECTしています。</p>

    <pre class="code lang-perl">$WWW::Salesforce::SF_PROXY = &#39;https://www.salesforce.com/services/Soap/u/20.0&#39;;</pre>
<p>この行では、APIのバージョンを指定しています。<br />
WWW::Salesforceのデフォルトではバージョンが古くChatterを取得できませんので、ここでは現時点で最新の20.0を指定しています。</p><p>上記の出力結果のサンプルは以下のような形です。</p>

    <pre class="code lang-perl">$VAR1 = [
          bless( {
                   &#39;FeedTrackedChanges&#39; =&gt; undef,
                   &#39;Id&#39; =&gt; [
                           &#39;*****&#39;,
                           &#39;*****&#39;
                         ],
                   &#39;CreatedBy&#39; =&gt; bless( {
                                         &#39;Id&#39; =&gt; undef,
                                         &#39;type&#39; =&gt; &#39;Name&#39;,
                                         &#39;Name&#39; =&gt; &#34;ここに名前がはいります&#34;
                                       }, &#39;sObject&#39; ),
                   &#39;Parent&#39; =&gt; bless( {
                                      &#39;Id&#39; =&gt; undef,
                                      &#39;type&#39; =&gt; &#39;Name&#39;,
                                      &#39;Name&#39; =&gt; &#34;ここに名前がはいります&#34;
                                    }, &#39;sObject&#39; ),
                   &#39;FeedComments&#39; =&gt; undef,
                   &#39;FeedPost&#39; =&gt; bless( {
                                        &#39;Id&#39; =&gt; undef,
                                        &#39;LinkUrl&#39; =&gt; undef,
                                        &#39;type&#39; =&gt; &#39;FeedPost&#39;,
                                        &#39;Title&#39; =&gt; undef,
                                        &#39;Body&#39; =&gt; &#34;ここに本文がはいります&#34;
                                      }, &#39;sObject&#39; ),
                   &#39;Type&#39; =&gt; &#39;ContentPost&#39;,
                   &#39;CreatedDate&#39; =&gt; &#39;2010-12-19T12:54:03.000Z&#39;,
                   &#39;CreatedById&#39; =&gt; &#39;*****&#39;,
                   &#39;FeedPostId&#39; =&gt; &#39;*****&#39;,
                   &#39;type&#39; =&gt; &#39;NewsFeed&#39;,
                   &#39;ParentId&#39; =&gt; &#39;*****&#39;
                 }, &#39;sObject&#39; ),
          bless( ....続く</pre>
<p>データには様々なIDが含まれていますが、force.comプラットフォーム内で使用されているもので、それぞれのオブジェクトにユニークな形で振られているので、同一判定等には使えますが、フィードを読むだけであれば不要です。</p><p>これによって、投稿日、ユーザー名、本文など、タイムラインの基本情報を取得することができましたので、</p>

<ul>
<li>XML::RSSでRSSを生成して、RSSリーダーで読んだり</li>
<li>AnyEvent::IRC::Clientを使ってIRCにPostしたり</li>
<li>Growl関連のモジュールを使ってGrowlに通知したり</li>
</ul><p>と、様々な方法でChatterのタイムラインを見ることができます。<br />
これでブラウザを開かなくてもチームから取り残されずに済みますね。</p>

<div class="section">
    <h3>まとめ</h3>
    <p>Advent Calendarの前の方でGoogle SpreadSheetの紹介が出てきたので、もう少しニッチなツールに触れてみるのも面白いかなと思い、敢えてChatterを取り上げてみました。<br />
バグトラッキングツールやタスク管理ツール等をforce.comプラットフォーム内に構築することで、それをChatterと連携させることで、開発上のコミュニケーションが楽になるかなと想像しています。<br />
100人以下のチームで仕事をすることは多いと思いますが、その際のツールとして無料で使えるChatterを選んでみるというのも手かもしれませんね。</p><p>さて、どんどんとクリスマスが近づいてきましたが、明日はyaottiさんの登場です。<br />
テストについて書かれるそうです。算数以外のテストは少し苦手なので、私も参考にしたいです。</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
