<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>Pseudo closures in XS - Articles Advent Calendar 2010 English</title>
        <meta name="title" content="Pseudo closures in XS - Articles Advent Calendar 2010 English">
        <meta name="description" content="">
        <meta name="author" content="">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://perl-users.jp/articles/advent-calendar/2010/english/3">
        <meta property="og:title" content="Pseudo closures in XS - Articles Advent Calendar 2010 English">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:Pseudo%20closures%20in%20XS,co_rgb:000000,w_900,c_fit//v1601626948/og-perl-users-jp.png">

        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://perl-users.jp/articles/advent-calendar/2010/english/3">
        <meta property="twitter:title" content="Pseudo closures in XS - Articles Advent Calendar 2010 English">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:Pseudo%20closures%20in%20XS,co_rgb:000000,w_900,c_fit//v1601626948/og-perl-users-jp.png">

        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2010/english/3">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body>
        <header class="site-header">
    <a href="/" class="logo">Perl-users.jp</a>
</header>

        <main class="entry">
        <h1 class="entry-title">Pseudo closures in XS</h1>
        <div class="entry-tags">
        </div>
            <div class="entry-date">2010-12-03</div>

        <div class="entry-text">
            <p>This article describes <strong>pseudo closures in XS</strong>, a.k.a. XS code templates, which creates XSUBs dynamically without compilation. Because XSUBs are typically much faster than pure Perl subroutines, creating XSUBs without compilation will be useful for high performance applications.</p><p></p>

<div class="section">
    <h3>Closure</h3>
    <p>What are <em>closures</em>? A closure is a subroutine that consists of <em>binding (or external) data</em> and <em>code</em>, which allows us to create subroutines dynamically without compilation, used especially in class builders. The following example is a simplest closure that create a counter, which consists of <em>$i</em> and the increment operator (++):</p>

    <pre class="code prettyprint lang-perl">my $i       = 42;           # binding data
my $closure = sub { $i++ }; # data + code</pre>
<p>Although this is a technique to make subroutines dynamically, the dynamic part is only the binding <em>data</em>, while the code part is statically defined. Thus, this technique can be applied to XSUBs.</p><p>An XSUB is a Perl subroutine which has a C function, and a subroutine is a type of SV. In Perl internal world, any SVs are able to have struct MAGIC, which can have other SVs. That is, we can bind SVs to XSUBs. However, Perl API doesn't support closures directly, so I call this technique <strong>pseudo closures</strong>.</p>

</div>
<div class="section">
    <h3>Implementation</h3>
    <p>The actual implementation explained here is taken from Mouse, which is a Moose<br />
compatible class builder with an XS implementation. The accessors Mouse provides are implemented in XS with this pseudo closure technique. Its basic idea is the same as Perl's: defining XSUBs statically, then binding Perl data to these XSUBs in run-time.</p><p>Take the rw accessor from <a href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=gitmo/Mouse.git;a=blob_plain;f=xs-src/MouseAccessor.xs;hb=master">Mouse/xs-src/MouseAccessors.xs</a> for example:</p>

    <pre class="code prettyprint lang-xs">/* snip */
#define dMOUSE_self  SV* const self = \
        mouse_accessor_get_self(aTHX_ ax, items, cv)
/* snip */
XS(XS_Mouse_accessor)
{
    /* setup XSUB args */
    dVAR; dXSARGS;
    dMOUSE_self; /* my $self = shift @_ */
    MAGIC* const mg = (MAGIC*)XSANY.any_ptr; /* fetch the bound data */

    SP -= items; /* PPCODE */
    PUTBACK;

    if(items == 1){ /* reader */
        mouse_attr_get(aTHX_ self, mg);
    }
    else if (items == 2){ /* writer */
        mouse_attr_set(aTHX_ self, mg, ST(1));
    }
    else{
        mouse_throw_error(MOUSE_mg_attribute(mg), NULL,
            &#34;Expected exactly one or two argument for an accessor of %&#34;SVf,
            MOUSE_mg_slot(mg));
    }
}</pre>
<p>This is the prototype of all the rw accessor (and of course, other accessors are defined in the file). The data part is attached as a MAGIC, but available from <em>XSANY.any_ptr</em> for convenience.</p><p>The following function is an XSUB generator which creates an XSUB and bind data to the XSUB:</p>

    <pre class="code prettyprint lang-xs">CV*
mouse_accessor_generate(pTHX_ SV* const attr, XSUBADDR_t const accessor_impl){
    AV* const xa = mouse_get_xa(aTHX_ attr);
    CV* xsub;
    MAGIC* mg;

    xsub = newXS(NULL, accessor_impl, __FILE__);
    sv_2mortal((SV*)xsub);

    mg = sv_magicext((SV*)xsub, MOUSE_xa_slot(xa),
        PERL_MAGIC_ext, &amp;mouse_accessor_vtbl, (char*)xa, HEf_SVKEY);

    MOUSE_mg_flags(mg) = (U16)MOUSE_xa_flags(xa);

    /* NOTE:
     * although we use MAGIC for gc, we also store mg to
     * CvXSUBANY for efficiency (gfx)
     */
    CvXSUBANY(xsub).any_ptr = (void*)mg;

    return xsub;
}</pre>
<p><em>XS_Mouse_accessor</em> is passed to this function as an <em>accessor_impl</em> parameter. The <em>attr</em> parameter is an instance of Mouse::Meta::Attribute. The bound data are managed by the Perl interpreter, they are released in the same way as Perl's closures.</p><p>This technique might not be easy for everyone, but its power is fascinating. Enjoy metaprogramming in XS!</p>

</div>
<div class="section">
    <h3>See Also</h3>
    <p>This technique is already used in some CPAN modules, e.g. <a href="http://search.cpan.org/dist/Mouse">Mouse</a>.</p><p><a href="http://search.cpan.org/dist/Mouse/">http://search.cpan.org/dist/Mouse/</a><br />
<a href="http://search.cpan.org/dist/Class-XSAccessor/">http://search.cpan.org/dist/Class-XSAccessor/</a></p>

</div>
<div class="section">
    <h3>Author</h3>
    <p>Fuji, Goro (gfx) - <a href="http://github.com/gfx/">http://github.com/gfx/</a></p>

</div>
        </div>
        </main>
        <footer class="site-footer">
    <nav>
        <a href="https://github.com/perl-users-jp/perl-users-jp.github.io" target="_blank" rel="noopener">
            <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
    </nav>
    <p>
        <a href="/">Perl-users.jp</a> - 日本のPerlユーザーのためのハブサイトです。日本の Perl ユーザーに最新の情報を届けることを目的にしています。
    </p>
    <p>
    文章のライセンスは、特に明記が無い限りすべて <a href="http://creativecommons.org/licenses/by/2.0/">CC-by</a>でおねがいします。
    </p>
</footer>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
