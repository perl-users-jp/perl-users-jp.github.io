<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>記号プログラミングで学ぶRuby1.9の仕様変更?? - Articles Advent Calendar 2010 Sym</title>
        <meta name="title" content="記号プログラミングで学ぶRuby1.9の仕様変更?? - Articles Advent Calendar 2010 Sym">
        <meta name="description" content="">
        <meta name="author" content="takesako">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://perl-users.jp/articles/advent-calendar/2010/sym/13">
        <meta property="og:title" content="記号プログラミングで学ぶRuby1.9の仕様変更?? - Articles Advent Calendar 2010 Sym">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E8%A8%98%E5%8F%B7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%A7%E5%AD%A6%E3%81%B6Ruby1.9%E3%81%AE%E4%BB%95%E6%A7%98%E5%A4%89%E6%9B%B4%3F%3F,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:takesako,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://perl-users.jp/articles/advent-calendar/2010/sym/13">
        <meta property="twitter:title" content="記号プログラミングで学ぶRuby1.9の仕様変更?? - Articles Advent Calendar 2010 Sym">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E8%A8%98%E5%8F%B7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%A7%E5%AD%A6%E3%81%B6Ruby1.9%E3%81%AE%E4%BB%95%E6%A7%98%E5%A4%89%E6%9B%B4%3F%3F,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:takesako,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2010/sym/13">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>記号プログラミングで学ぶRuby1.9の仕様変更??</h1>
        tag
            <a href='/tag/sym'>sym</a>
            <a href='/tag/ruby'>ruby</a>

        <p>またまた再登場の<a href="http://twitter.com/TAKESAKO">id:TAKESAKO</a>です。<br />
今日は<a href="/articles/advent-calendar/2010/sym/4">Ruby1.8で学ぶ、簡単?!記号プログラミング</a>から発展した話題「記号プログラミングで学ぶRuby1.9の仕様変更??」についてお話ししたいと思います。</p>

<div class="section">
    <h3>Ruby 1.8 と 1.9 の非互換</h3>
    <p>Ruby1.8以前では ?a は'a'のASCIIコードの数値97が返されていましたが、<br />
Ruby1.9からは長さ1の文字列"a"を返すように仕様変更されました。</p><p>これはRuby1.9からの多言語対応のためで、文字列をバイト列ではなく文字単位で扱うようになったためです。</p>

    <pre class="code prettyprint">ruby1.9&gt; p ?a
&#34;a&#34;

ruby1.8&gt; p ?a
97</pre>
<p>したがって、?? は Ruby1.9では文字列"?"のことですが、Ruby1.8以前では'?'のアスキーコードである63の数値を返すことになります。</p>

    <pre class="code prettyprint">ruby1.9&gt; p ??
&#34;?&#34;

ruby1.8&gt; p ??
63</pre>

</div>
<div class="section">
    <h3>文字列と数値の%演算子の違い</h3>
    <p>次に数値と文字列における%演算子の違いですが、文字列の"?"%"?"はsprintf("?","?")と同じ動きをして結果は"?"となりますが、数値の63%63は63÷63＝商1…余り0の余りを返すため0となります。</p>

    <pre class="code prettyprint">ruby1.9&gt; p ??%??
&#34;?&#34;

ruby1.8&gt; p ??%??
0</pre>
<p>これを利用してRuby1.9の処理系かどうかを記号9バイトだけで判定することができます。</p>

</div>
<div class="section">
    <h3>記号のみでバージョン1.9判定</h3>
    <p>RUBY_VERSION の12文字を使うよりも圧倒的に短いです。地球に優しくてエコですね。:-)</p>

    <pre class="code prettyprint">ruby1.9&gt; p ??%??==??
true

ruby1.8&gt; p ??%??==??
false</pre>

</div>
<div class="section">
    <h3>記号のみで任意の文字列を作成する方法</h3>
    <p>Rubyで任意の文字列を生成するには""<<数値(ASCIIコード)という文字列の破壊的演算を行なう構文を利用するのが簡単です。</p>

    <pre class="code prettyprint">ruby1.9&gt; p &#39;&#39;&lt;&lt;123
&#34;{&#34;

ruby1.8&gt; p &#39;&#39;&lt;&lt;123
&#34;{&#34;</pre>
<p>任意の数値を作成するには、Ruby1.8以前では?{-?|などを利用してできたのですが、Ruby1.9からは先の仕様変更があるため使えません。どうするかというと、正規表現を利用します。</p>

    <pre class="code prettyprint">ruby1.9&gt; p //=~&#39;&#39;
0

ruby1.8&gt; p //=~&#39;&#39;
0</pre>
<p>正規表現にマッチした場所を文字列の先頭から数えて結果を返します。</p>

    <pre class="code prettyprint">ruby1.9&gt; p /_/=~&#39;&gt;_&#39;
1

ruby1.8&gt; p /_/=~&#39;&gt;_&#39;
1</pre>
<p>これを利用すると、こちらで用意した文字列から目的の先頭バイト数でマッチする正規表現を書いてあげれば、任意の数値を作成することができます。これは記号だけを使って実現できます。</p>

    <pre class="code prettyprint">ruby1.9&gt; p /_/=~&#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;_&#39;
9

ruby1.8&gt; p /_/=~&#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;_&#39;
9</pre>

</div>
<div class="section">
    <h3>(''<<数値)で任意のASCIIコードの文字を標準出力 $> に書き込む</h3>
    <p>以上のテクニックを組み合わせると、$> << "文字列" と書くことを利用して任意の文字列を標準出力に書き込むことができます。</p>

    <pre class="code prettyprint">ruby1.9&gt; $&gt;&lt;&lt;(&#39;&#39;&lt;&lt;88)+(&#39;&#39;&lt;&lt;89)+(&#39;&#39;&lt;&lt;90)
XYZ

ruby1.8&gt; $&gt;&lt;&lt;(&#39;&#39;&lt;&lt;88)+(&#39;&#39;&lt;&lt;89)+(&#39;&#39;&lt;&lt;90)
XYZ</pre>
<p>これで、Ruby1.8とRuby1.9のどちらのバージョンでも動くプログラムを作成できました。</p>

    <pre class="code prettyprint">$&gt;&lt;&lt;(&#39;&#39;&lt;&lt;(88)&lt;&lt;(89)&lt;&lt;(90))</pre>
<p>これを「Hello, world!\n」を出力するようにASCIIコードの数値を調整して</p>

    <pre class="code prettyprint">$&gt;&lt;&lt;(&#39;&#39;&lt;&lt;(72)&lt;&lt;(101)&lt;&lt;(108)&lt;&lt;(108)&lt;&lt;(111)&lt;&lt;(44)&lt;&lt;(32)&lt;&lt;(119)&lt;&lt;(111)&lt;&lt;(114)&lt;&lt;(108)&lt;&lt;(100)&lt;&lt;(33)&lt;&lt;(10))</pre>
<p>それぞれの数字を返す正規表現に置き換えると</p>

    <pre class="code prettyprint">
$&gt;&lt;&lt;(&#39;&#39;&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_^)/;(^_^)/;(^_^)/;(^_^)=&#39;)&lt;&lt;(/=/=~&#39;(^_^)/;(^_=&#39;))
</pre>
<p>無事、顔文字だらけになりました。めでたし、めでたし。</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
