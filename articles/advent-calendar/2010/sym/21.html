<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>Linux/gccで記号プログラミング - Articles Advent Calendar 2010 Sym</title>
        <meta name="title" content="Linux/gccで記号プログラミング - Articles Advent Calendar 2010 Sym">
        <meta name="description" content="">
        <meta name="author" content="hotpepsi">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://perl-users.jp/articles/advent-calendar/2010/sym/21">
        <meta property="og:title" content="Linux/gccで記号プログラミング - Articles Advent Calendar 2010 Sym">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:Linux%2Fgcc%E3%81%A7%E8%A8%98%E5%8F%B7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:hotpepsi,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://perl-users.jp/articles/advent-calendar/2010/sym/21">
        <meta property="twitter:title" content="Linux/gccで記号プログラミング - Articles Advent Calendar 2010 Sym">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:Linux%2Fgcc%E3%81%A7%E8%A8%98%E5%8F%B7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:hotpepsi,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2010/sym/21">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Linux/gccで記号プログラミング</h1>
        tag
            <a href='/tag/sym'>sym</a>
            <a href='/tag/x86'>x86</a>

        <p>こんにちは。<a href="http://twitter.com/hotpepsi">hotpepsi</a>です。<br />
以下はx86のLinuxで動作するhello.cのソースコードです。</p>

    <pre class="code prettyprint lang-c">__[]={
((((((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;,&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;,&#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;%&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;$&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;(&#39;-&#39; &#39;))),
((((((&#39;(&#39;-&#39;!&#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;(&#39;-&#39;!&#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;#&#39;-&#39;!&#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;#&#39;-&#39;!&#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;,&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;/&#39;-&#39; &#39;))),
((((((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;$&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;,&#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;(&#39;-&#39;!&#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;#&#39;-&#39;!&#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;&amp;&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;/&#39;-&#39; &#39;))),
((((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;*&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;#&#39;-&#39;!&#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;!&#39;-&#39; &#39;))),
};
_[]={
((((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;$&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;+&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;(&#39;-&#39; &#39;))),
((((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;.&#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;+&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;*&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))),
((((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;!&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;+&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;+&#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))),
((((((&#39;+&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;)&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39; &#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))),
__,
((((((&#39;,&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;#&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;!&#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;(&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;,&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;-&#39;-&#39; &#39;))),
((((((&#39;)&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;(&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;)))&lt;&lt;(&#39;=&#39;-&#39;-&#39;))|
(((((&#39;,&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39;-&#39;-&#39; &#39;))&lt;&lt;(&#39;(&#39;-&#39; &#39;))|
(((&#39;$&#39;-&#39; &#39;)&lt;&lt;(&#39;$&#39;-&#39; &#39;))|(&#39; &#39;-&#39; &#39;))),
};</pre>
<p>実行ファイルは</p>

    <pre class="code prettyprint"># gcc -c hello.c
# ld hello.o -o hello -e _</pre>
<p>で作成することができます。</p><p>前回はついdefineを使ってしまいましたが、-Dオプションは本文に入れるべきdefine文をコマンドラインに出しただけ、と考えると反則でした。<br />
なので今回はdefineなしでやってみました。</p><p>元ネタは</p>

    <pre class="code prettyprint">char main[] = &#34;...&#34;;</pre>
<p>という形でした。ここからcharとmainをなくしてみます。<br />
まず型宣言のcharですが、これを省略するとint型になるので</p>

    <pre class="code prettyprint">main[] = { ... };</pre>
<p>のようにint型の配列として初期化することにします。<br />
次にmainですが、さて、世の中にはmain関数を使わないC言語のプログラムもたくさん存在します。<br />
別にmainでなくてもよいのです。とりあえず _ という名前にしてみます。すると</p>

    <pre class="code prettyprint">_[] = { ... };</pre>
<p>という形になりました。元ネタと同様、変数としてバイナリを定義してコードとして実行させます。<br />
これなら記号だけでいけそうです。<br />
エントリポイントを _ にしてリンクすれば、mainではなく _ からプログラムを開始できます。<br />
（Cのランタイムライブラリが使えませんが、どのみちアルファベットを使用する関数は呼べないので問題ありません）</p><p>初期化要素として使うint型の値ですが、記号だけでint型の変数、といえば記号プログラミングではおなじみの '_' などが丁度よくint型ですのでこれを使います。<br />
0と1さえ表せればあとは演算子でどうにでもなりますが、ASCII文字コード表を眺めていたら0から0x10まで作れそうだったので用意してみました。</p>

    <pre class="code prettyprint">0 &#39; &#39;-&#39; &#39;
1 &#39;!&#39;-&#39; &#39;
2 &#39;#&#39;-&#39;!&#39;
3 &#39;#&#39;-&#39; &#39;
4 &#39;$&#39;-&#39; &#39;
5 &#39;%&#39;-&#39; &#39;
6 &#39;&amp;&#39;-&#39; &#39;
7 &#39;(&#39;-&#39;!&#39;
8 &#39;(&#39;-&#39; &#39;
9 &#39;)&#39;-&#39; &#39;
A &#39;*&#39;-&#39; &#39;
B &#39;+&#39;-&#39; &#39;
C &#39;,&#39;-&#39; &#39;
D &#39;-&#39;-&#39; &#39;
E &#39;.&#39;-&#39; &#39;
F &#39;/&#39;-&#39; &#39;
10 &#39;=&#39;-&#39;-&#39;</pre>
<p>この0～0x10までを使って、「Hello, world!」という文字列と、それを表示するコードを作ります。<br />
上の記号を手で書くのは不便なので、数値を記号に変換することを考えてみます。<br />
変換、そうdefineです。</p>

    <pre class="code prettyprint lang-c">#define _0 &#39; &#39;-&#39; &#39;</pre>
<p>数値そのままではシンボルにならないので_をつけましたが、これでなんとなく可読性のある数値によりプログラミングできそうです。より具体的には以下のようにします。</p>

    <pre class="code prettyprint lang-c">#define _0 &#39; &#39;-&#39; &#39;
#define _1 &#39;!&#39;-&#39; &#39;
#define _2 &#39;#&#39;-&#39;!&#39;
#define _3 &#39;#&#39;-&#39; &#39;
#define _4 &#39;$&#39;-&#39; &#39;
#define _5 &#39;%&#39;-&#39; &#39;
#define _6 &#39;&amp;&#39;-&#39; &#39;
#define _7 &#39;(&#39;-&#39;!&#39;
#define _8 &#39;(&#39;-&#39; &#39;
#define _9 &#39;)&#39;-&#39; &#39;
#define _A &#39;*&#39;-&#39; &#39;
#define _B &#39;+&#39;-&#39; &#39;
#define _C &#39;,&#39;-&#39; &#39;
#define _D &#39;-&#39;-&#39; &#39;
#define _E &#39;.&#39;-&#39; &#39;
#define _F &#39;/&#39;-&#39; &#39;
#define _10 &#39;=&#39;-&#39;-&#39;

#define MAKE8(a,b) ((a)&lt;&lt;(_4))|(b)
#define MAKE16(a,b,c,d) ((MAKE8(c,d))&lt;&lt;(_8))|(MAKE8(a,b))
#define MAKE32(a,b,c,d,e,f,g,h) ((MAKE16(e,f,g,h))&lt;&lt;(_10))|(MAKE16(a,b,c,d))</pre>
<p>defineは使わないんじゃなかったのかよ、とお思いかもしれませんが、これは記号のコードを生成するだけのために利用します。<br />
実は先頭のソースコードの元データはこのようになっています。</p>

    <pre class="code prettyprint lang-c">hello[]={
MAKE32(_4,_8,_6,_5,_6,_C,_6,_C),  // Hell
MAKE32(_6,_F,_2,_C,_2,_0,_7,_7),  // o, w
MAKE32(_6,_F,_7,_2,_6,_C,_6,_4),  // orld
MAKE32(_2,_1,_0,_A,_0,_0,_0,_0),  // !\n
};
main[]={
MAKE32(_B,_8,_0,_4,_0,_0,_0,_0),  // movl $4, %eax
MAKE32(_0,_0,_B,_A,_0,_E,_0,_0),  // movl $0xE, %edx
MAKE32(_0,_0,_0,_0,_B,_B,_0,_1),  // movl $1, %ebx
MAKE32(_0,_0,_0,_0,_0,_0,_B,_9),  // movl hello, %ecx
hello,  // なんとintとポインタのサイズが同じ!
MAKE32(_C,_D,_8,_0,_3,_1,_C,_0),  // int $0x80 / xorl %eax, %eax
MAKE32(_4,_0,_C,_D,_8,_0,_9,_0),  // incl %eax / int $0x80
};</pre>
<p>MAKE32マクロを利用してこれを</p>

    <pre class="code prettyprint"># gcc -E hello.c</pre>
<p>として展開すると、プリプロセッサが記号に変換してくれるのがわかると思います。</p>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
