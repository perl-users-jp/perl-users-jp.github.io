<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>クライアントサイドJSでもサーバーサイドJSでもうごくテストを書く - Articles Advent Calendar 2011 Amon2</title>
        <meta name="title" content="クライアントサイドJSでもサーバーサイドJSでもうごくテストを書く - Articles Advent Calendar 2011 Amon2">
        <meta name="description" content="">
        <meta name="author" content="tokuhirom">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://perl-users.jp/articles/advent-calendar/2011/amon2/4">
        <meta property="og:title" content="クライアントサイドJSでもサーバーサイドJSでもうごくテストを書く - Articles Advent Calendar 2011 Amon2">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B5%E3%82%A4%E3%83%89JS%E3%81%A7%E3%82%82%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B5%E3%82%A4%E3%83%89JS%E3%81%A7%E3%82%82%E3%81%86%E3%81%94%E3%81%8F%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E6%9B%B8%E3%81%8F,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:tokuhirom,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://perl-users.jp/articles/advent-calendar/2011/amon2/4">
        <meta property="twitter:title" content="クライアントサイドJSでもサーバーサイドJSでもうごくテストを書く - Articles Advent Calendar 2011 Amon2">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B5%E3%82%A4%E3%83%89JS%E3%81%A7%E3%82%82%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B5%E3%82%A4%E3%83%89JS%E3%81%A7%E3%82%82%E3%81%86%E3%81%94%E3%81%8F%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E6%9B%B8%E3%81%8F,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:tokuhirom,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2011/amon2/4">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>クライアントサイドJSでもサーバーサイドJSでもうごくテストを書く</h1>
        tag
            <a href='/tag/perl'>perl</a>
            <a href='/tag/js'>js</a>

        <p>こんにちは! tokuhirom です。日曜日ですね!<br />
今日は Test トラックにかこうとしたけど Perl 関係なさすぎて自重したネタをかこうかとおもいます。</p><p>さて、Amon2 の重要なパーツといえる strftime.js ですが、こちらもちゃんとテストしなくてはなりません。strftime とかいちばんテストしやすいうえにバグりやすいのに、テストしてないライブラリがおおくてなさけなくなる今日この頃ですからね。</p>

<div class="section">
    <h4>テストライブラリの選定</h4>
    <p>さて、Perl ならば Test::More をとりあえずつかっておけばいいのですが、JS の場合はどれをつかうべきかなやむところです。JS の場合、いろんな人がオレオレなテストフレームワークをだしててややこしいことこの上ありません。</p><p>こういう場合、Perl でも JavaScript でもライブラリの選定方法はかわりません。譲れない機能、ライブラリの出来などを評価していくのです。今回の場合、ゆずれない点としては</p>

<ul>
<li>「ブラウザでもコンソールでもおなじテストが実行できる」</li>
<li>「けぶかくない」</li>
<li>「vendor/ みたいなところにテストライブラリ自体をつっこめる」</li>
</ul><p>という点がありました。コンソールでテストしながら開発したいけど、ブラウザ上での動作確認もねんのためおこなっておきたいですからね。</p><p>いくつか条件に合致するものとして</p>

<ul>
<li>mocha( <a href="http://d.hatena.ne.jp/hokaccha/20111202/1322840375">http://d.hatena.ne.jp/hokaccha/20111202/1322840375</a> )</li>
<li>QUnit</li>
</ul><p>あたりがあがったのですが、mocha はいいんですが、いかんせんググラビリティが低いのと、assertion をもちいたテストなのであって、should.js などとのくみあわせが必要だったりしてめんどくさいかんじがしました。</p><p>そこで QUnit をつかうことにしたのですが、qunit の場合はセットアップは簡単で</p>

<ul>
<li>qunit-git.css</li>
<li>qunit.js</li>
</ul><p>の2つのファイルをとってきて配置し、index.html をかけばよいです。なんなら index.html の中にテストをかいてもいいです。</p>

</div>
<div class="section">
    <h4>ブラウザでのテスト</h4>
    <p>今回は index.html を以下のようにしました。AJAX をつかうためだけに jQuery をつかっているところがゆとり乙的なかんじですが、まあいいでしょう。今回、node やブラウザに依存した部分を排除するために AJAX でデータをとってきてそれを eval するようにしています。また、subtest や is といった Perl で慣れた名前にエイリアスをはっています。</p>

    <pre class="code prettyprint lang-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
        &lt;meta charset=&#34;UTF-8&#34; /&gt;
        &lt;title&gt;QUnit Test Suite&lt;/title&gt;
        &lt;link rel=&#34;stylesheet&#34; href=&#34;./qunit-git.css&#34; type=&#34;text/css&#34; media=&#34;screen&#34;&gt;
        &lt;script type=&#34;text/javascript&#34; src=&#34;./qunit.js&#34;&gt;&lt;/script&gt;
        &lt;script type=&#34;text/javascript&#34; src=&#34;../strftime.js&#34;&gt;&lt;/script&gt;
        &lt;script type=&#34;text/javascript&#34; src=&#34;http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.6.1.min.js&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34;&gt;
        $(function () {
            $.ajax({url:&#39;../t/01_strftime.js&#39;, dataType: &#39;text&#39;}).success(function (dat) {
                with ({is: QUnit.equal, subtest: QUnit.test}) {
                    subtest(&#39;strftime&#39;, function () {
                        eval(dat);
                    });
                }
            });
        });
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;h1 id=&#34;qunit-header&#34;&gt;QUnit Test Suite&lt;/h1&gt;
        &lt;h2 id=&#34;qunit-banner&#34;&gt;&lt;/h2&gt;
        &lt;div id=&#34;qunit-testrunner-toolbar&#34;&gt;&lt;/div&gt;
        &lt;h2 id=&#34;qunit-userAgent&#34;&gt;&lt;/h2&gt;
        &lt;ol id=&#34;qunit-tests&#34;&gt;&lt;/ol&gt;
        &lt;div id=&#34;qunit-fixture&#34;&gt;test markup&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

</div>
<div class="section">
    <h4>node.js でのテスト</h4>
    <p>さて、次はおなじテストスクリプトで node.js でもテストできるようにしましょう。</p><p>node.js で QUnit するには t-wada さんのかいた qunit-tap というライブラリをつかえばいいそうです。このへんについては id:sugyan の記事が参考になるかとおもいます( <a href="http://d.hatena.ne.jp/sugyan/20110325/1301061279">http://d.hatena.ne.jp/sugyan/20110325/1301061279</a> )。</p><p>まずは npm で以下のようにしてインストールしましょう。</p>

    <pre class="code prettyprint lang-shell">npm install qunit-tap</pre>
<p>今回の場合にはテストローダは以下のようにかいてみました。簡単ですね。</p>

    <pre class="code prettyprint lang-js">var QUnit = require(&#39;./qunit&#39;).QUnit,
    qunitTap = require(&#39;qunit-tap&#39;).qunitTap,
    sys = require(&#39;sys&#39;),
    fs = require(&#39;fs&#39;);

qunitTap(QUnit, sys.puts, {noPlan: true});

QUnit.init();
QUnit.config.updateRate = 0;

require(&#39;../strftime&#39;);
with ({is: QUnit.equal, subtest: QUnit.test}) {
    var content = fs.readFileSync(&#39;t/01_strftime.js&#39;, &#39;utf-8&#39;);
    subtest(&#39;strftime&#39;, function () {
        eval(content);
    });
}

QUnit.start();</pre>
<p>しあげに Makefile をかきました。これでいつでも簡単に誰でもテストをうごかすことができます。</p>

    <pre class="code prettyprint">test:
        node test/node-test.js
test-browser:
        @echo &#34;Access to http://localhost:9041/test/index.html&#34;
        plackup -p 9041 -e &#39;use Plack::App::Directory; Plack::App::Directory-&gt;new()-&gt;to_app()&#39;
test-setup:
        npm install qunit-tap

.PHONY: test test-browser test-setup</pre>

</div>
<div class="section">
    <h4>まとめ</h4>
    <p>本日は<B>Amon2 のうち</B>strftime.jsのテスト、すなわち<B>ブラウザとクライアントの両方でうごくテストを書くの法</B>についてのべました。</p><p>簡単なので、おためしあれ。</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
