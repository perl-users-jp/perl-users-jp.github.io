<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="hatak">
        <title>Geo::Coordinates::Converter - 位置座標の測地系やフォーマットを変換する - Articles Advent Calendar 2011 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Geo::Coordinates::Converter - 位置座標の測地系やフォーマットを変換する</h1>

        <p>こんにちは。<a href="http://blog.hatak.net/">hatak</a> (@hisashi) と申します。</p><p>モバイルデバイスでは GPS やネットワーク測位などで位置座標を簡単に取得できます。しかし、緯度や経度の計算は意外と面倒なものです。<br />
14 日目は、このような位置座標を扱うときに便利なモジュール Geo::Coordinates::Converter をご紹介します。</p><p></p>

<div class="section">
    <h4>測地系の違い</h4>
    <p>緯度経度で表された座標を扱う場合、「測地系」という基準を考える必要があります。<br />
測地系には様々な種類があります。日本国内で利用されることの多い測地系は次の 3 種類です。</p>

<ul>
<li>世界測地系 1984 (WGS84)
<ul>
<li>アメリカで策定された測地系</li>
<li>GPS や Google Map などで採用されている</li>
</ul></li>
<li>日本測地系 2000 (JGD2000)
<ul>
<li>日本で策定された測地系</li>
<li>2002 年以降の国内の基盤地図などで採用されている</li>
</ul></li>
<li>旧日本測地系 (Tokyo)
<ul>
<li>2002 年以前に日本で採用されていた測地系</li>
<li>日本国内のいくつかのオンライン地図はこちらで提供されている</li>
</ul></li>
</ul><p>緯度経度の数値を見ただけでは区別がつきませんが、異なる測地系の座標を重ねた場合にはずれが生じることがあります。<br />
場所にも依りますが、WGS84 と JGD2000 のズレは 0.1mm 前後と言われているため、現在のモバイルデバイスの測位レベルでは無視できる差異といえます。一方、JGD2000 と Tokyo のズレは関東で 400m 前後と言われており、変換が必要となってきます。</p><br />
<p></p>

</div>
<div class="section">
    <h4>Geo::Coordinates::Converter で測地系変換</h4>
    <p>この測地系間の変換を手軽に行えるモジュールが Geo::Coordinates::Converter です。</p>

<ul>
<li><a href="http://search.cpan.org/dist/Geo-Coordinates-Converter/">Kazuhiro Osawa / Geo-Coordinates-Converter - search.cpan.org</a></li>
</ul><p>WGS84 の東京タワーの座標 (35.65861, 139.745447) を旧日本測地系に変換してみましょう。</p>

    <pre class="code lang-perl">#!perl

use strict;
use warnings;

use Geo::Coordinates::Converter;

# WGS84 の値をセット
my $converter = Geo::Coordinates::Converter-&gt;new(
    lat    =&gt; &#39;35.65861&#39;,
    lng    =&gt; &#39;139.745447&#39;,
    datum  =&gt; &#39;wgs84&#39;,
);

# WGS84 -&gt; Tokyo に変換して表示
my $point = $converter-&gt;convert(&#39;tokyo&#39;);
print $point-&gt;lat;
print $point-&gt;lon;</pre>
<p>緯度・経度のフォーマットは角度 (degree) と度分秒 (dms) どちらでセットしても自動で判別してくれます。もちろん、相互変換することもできます。</p><br />
<p></p>

</div>
<div class="section">
    <h4>GeoHash に変換</h4>
    <p><a href="http://geohash.org/">GeoHash</a> は、緯度と軽度をまとめて一つの文字列で表す座標表現です。</p><p>緯度経度をそれぞれ 2 進数で表現し、交互に並べた bit 列を Base32 でエンコードしたものが GeoHash です。<br />
GeoHash で表現される座標は矩形範囲の中心点であり、同時に座標を中心とした矩形の範囲も表しています。文字列の長さが長いほど大縮尺で狭い範囲を表すことになります。<br />
これを応用すると、指定範囲内にあるスポットを絞り込む処理が文字列比較だけで行えるというメリットがあります。</p><p>この GeoHash のエンコード・デコードのロジックは Geo::Hash モジュールで実装されています。</p>

<ul>
<li><a href="http://search.cpan.org/dist/Geo-Hash/">Andy Armstrong / Geo-Hash - search.cpan.org</a></li>
</ul><p>これを Geo::Coordinates::Converter から利用するフォーマッターが用意されています。</p>

<ul>
<li><a href="http://search.cpan.org/dist/Geo-Coordinates-Converter-Format-Geohash/">Kazuhiro Osawa / Geo-Coordinates-Converter-Format-Geohash - search.cpan.org</a></li>
</ul><p>実際に変換してみましょう。</p>

    <pre class="code lang-perl">#!perl

use strict;
use warnings;

use Geo::Coordinates::Converter;

Geo::Coordinates::Converter-&gt;add_default_formats(&#39;Geohash&#39;);

my $converter = Geo::Coordinates::Converter-&gt;new(
    lat    =&gt; &#39;35.65861&#39;,
    lng    =&gt; &#39;139.745447&#39;,
)-&gt;format(&#39;geohash&#39;);

# GeoHash に変換して表示
my $point = $converter-&gt;point;
print $point-&gt;geohash;</pre>
<p>もちろん、GeoHash から位置座標に変換することもできます。</p><br />
<p></p>

</div>
<div class="section">
    <h4>まとめ</h4>
    <p>位置座標変換を手軽に行える Geo::Coordinates::Converter モジュールを紹介しました。<br />
座標系は混在してしまうと表示時のズレとなってしまいます。デバイスで取得する際は取得時の座標系を基に内部で WGS84 などに統一して保持し、描画時に適切な座標系に変換してあげることが大切となります。<br />
また、文字列で表現する GeoHash も手軽に利用できますので、前処理などで使えば複雑な数値比較を最小限に抑えることもできます。</p><br />
<p>明日は lapis_tw さんです。お楽しみに！</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
