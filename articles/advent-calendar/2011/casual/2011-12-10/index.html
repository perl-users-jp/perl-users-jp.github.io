<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="hirobanex">
        <title>Object::Container ‐ Containerを使って開発スピードをあげる - Articles Advent Calendar 2011 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Object::Container ‐ Containerを使って開発スピードをあげる</h1>

        <p>こんにちは！<a href="http://twitter.com/hirobanex">hirobanex</a>です！PerlのWAFのKamuiを使って以来、Containerというのが大好きなんですが、どうもContainerというものがWeb上で見かけることが少ないのでカジュアルに紹介しますね！</p>

<div class="section">
    <h4>Containerとは</h4>
    <p>より一般的に言えば、newされたインスタンスやリファレンスをキャッシュしておくクラスで、いろんなクラスからそのクラス経由でキャッシュしたオブジェクトを利用するような形態のクラス、あるいは、そのクラスを生成をサポートするモジュール群、を指すといえると思います。</p><p>ここで紹介するのは、typesterさん作の<a href="http://search.cpan.org/~typester/Object-Container-0.14/">Object::Container</a>で、Containerクラスの生成をサポートするモジュールです。<a href="http://www.slideshare.net/zigorou/inside-mobage-platform">Inside mobage platform</a>をみると、しっかりしたところでも使われいるんだなーということが垣間見えます。</p>

</div>
<div class="section">
    <h4>Containerのメリット</h4>
    <p>私がContainerを使っていて一番嬉しいなーと思うのが、「開発スピードの向上」です。早速コードを書いてみましょう。</p>

    <pre class="code lang-perl">#まず、Containerのサブクラスを用意して、使いたいモジュールのコンストラクションコードを書きをしまくる
package MyContainer;
use Object::Container &#39;-base&#39;;
use WWW::Mechaniz;
use Furl;
use LWP::UserAgent;
use HTTP::Cookies;

register lwp =&gt; sub { 
    $ENV{&#39;HTTP_PROXY&#39;} = &#39;http://hogehoge.proxy.com:80&#39;;
    my $cookie_jar = HTTP::Cookies-&gt;new(file =&gt; $params-&gt;{cookie}, autosave =&gt; 1);

    LWP::UserAgent-&gt;new(
        agent      =&gt; &#39;mogemoge_crawler_lwp&#39;,
        timeout    =&gt; 300,
        max_size   =&gt; 1000000,
        cookie_jar =&gt; $cookie_jar,
        env_proxy  =&gt; 1,
    );
};

register mech =&gt; sub { 
    WWW::Mechanize-&gt;new(
        agent      =&gt; &#39;mogemoge_crawler_mech&#39;,
   );

register furl =&gt; sub { 
    Furl-&gt;new(
        agent   =&gt; &#39;mogemoge_crawler_mech&#39;,
        timeout =&gt; 10,
    );
};
1;</pre>

    <pre class="code lang-perl">#メインコード。useするのは、MyContainerだけ、すっきり♪
use MyContainer &#39;con&#39;;#conはキャッシュしたオブジェクトを呼び出す関数、任意の文字列をいれられる

con(&#39;mech&#39;)-&gt;get(&#39;http://example.com&#39;);#newしなくていい
con(&#39;furl&#39;)-&gt;get(&#39;http://example.com&#39;);#newしなくていい
con(&#39;lwp&#39;)-&gt;get(&#39;http://example.com&#39;);#newしなくていい</pre>
<p>いかがでしょうか？上記のコードでわかるとおり開発スピード、メンテナンス上の以下のメリットがあります。</p>

<ul>
<li>メインコードでuseしなくていい</li>
<li>メインコードでnewしなくていい</li>
<li>使いまわせるオブジェクトをMyContainerクラスで一覧管理できる</li>
<li>メインコードではそこのコードのロジックに集中できる</li>
</ul><p>すばらしいですね！みんなにすばらしさを伝えたくなりますね！</p>

</div>
<div class="section">
    <h4>Containerのデメリット、あるいは、危険性</h4>
    <p>Containerを使うととてもすっきりするのですが、残念ながら以下のような点に注意が必要です。</p>

<div class="section">
    <h5>どこからでもアクセスできるグーバル変数化によるスコープ無限拡大</h5>
    <p>基本的には、どこで使われてもいいようにContainerにいれてしまうんですが、「このインスタンスはそのケースで使用することを想定せずにnewのオプション渡しているよ」みたいな、Cotainerにインスタンス化のコード書いた人と別の人がなんとなくContainerにはいっているインスタンスを使い始めて、実は予期しないバグを生む可能性があるので注意です。</p><p>また、[/articles/advent-calendar/2010/hacker/3:title=『Scope::Container でリソース管理を行う』]でkazeburoさんが指摘されているように、データベースのコネクション管理上問題が出てくるケースもあるようです。</p>

</div>
<div class="section">
    <h5>インスタンスの中身が変化するタイプのインスタンスには使用できない</h5>
    <p>基本的にはContainerにキャッシュしたインスタンスは何回も使いまわす設定になっているので、DateTimeや、[/articles/advent-calendar/2011/casual/3:title=第三回にytnobodyさんが紹介されたCrypt::SaltedHash]のように使っていくうちに、インスタンスの中身がかわったりするモジュールのインスタンスをキャッシュするのには向きません。</p><p></p>

</div>
</div>
<div class="section">
    <h4>デメリットの克服</h4>
    <p>下記のContainerをなんらかのかたちで利用すると、上述のデメリットは克服することができます。</p>

<ul>
<li><a href="http://search.cpan.org/~nekokak/Object-Container-Exporter-0.03/">Object::Container::Exporter</a></li>
<li><a href="http://search.cpan.org/~dmaki/Pickles-0.08/lib/Pickles/Container.pm">Pickes::Container</a></li>
<li><a href="http://search.cpan.org/~kazeburo/Scope-Container-0.04/">Scope::Container</a></li>
</ul><p>このあたりを突っ込みだすとカジュアルじゃなくなるので、とりあえず、デメリットを意識してどんどん使ってみるといいと思います。それで、デメリットを克服したいなーとか、興味湧いてきたら、上記のモジュールを見たり、下記を参考にしてみてください。</p>

<ul>
<li><a href="http://search.cpan.org/~typester/Object-Container-0.14/lib/Object/Container/ja.pod">Object::Container::ja</a></li>
<li>Pickles::Container <a href="http://doc.7kai.org/Note/2.%E9%96%8B%E7%99%BA/Perl/Pickles/1.Tutorial/2.%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E5%88%A9%E7%94%A8">&#x30B3;&#x30F3;&#x30C6;&#x30CA;&#x306E;&#x5229;&#x7528; | The Document of Aska</a></li>
<li><a href="http://hirobanex.net/article/2011/12/1323507801">Container&#x3068;&#x3044;&#x3046;&#x540D;&#x306E;Perl&#x30E2;&#x30B8;&#x30E5;&#x30FC;&#x30EB;&#x7FA4;</a></li>
</ul>
</div>
<div class="section">
    <h4>まとめ</h4>
    <p>注意しながら、Containerを利用すると開発スピードが大変上がりますね！とてもすばらしいですね！是非、使ってみてブログとかに書くと認知度が上がってさらに++ですね！そして、Containerが一般的になるとうれしいですね！</p><p>さて、次はmemememomoさんです。See you again!</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
