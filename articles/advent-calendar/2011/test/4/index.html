<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="tokuhirom">
        <title>Module::Build で let's `make love` - Articles Advent Calendar 2011 Test</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Module::Build で let's `make love`</h1>

        <p>Win32 の プリンスキー<a href="#fn1" title="プリンが大好きな人のこと">*1</a> として知る人ぞ知るところの <a href="http://d.hatena.ne.jp/tokuhirom/">tokuhirom</a> です。<br />
マリオカート7にいそがしくてアドベントカレンダーをかく暇がありません。</p><p>さて、クリスマスも近いということで、みなさんも make love したいところだと思います。<br />
しかし、自力で Makefile をいじるのも大変です。<br />
「愛のためにはその程度の障害はむしろご褒美だ！」という人もいるかもしれませんが、僕は昨今話題の草植、もとい草食男子ですので、そんな面倒なことはできません。<br />
ここでは、perl で簡単に `make love` をするために書いたという経緯がない Module::Build を紹介します。</p><p>Module::Build ではハックっぽいことをしなくても簡単にいろいろと hook できるんです。make love も出来るのでリア充も安心！！</p>

<div class="section">
    <h4>使い方</h4>
    <p>たとえば、Module::Build で新しいテストのターゲット 「test_sl」 を定義すると以下のようになります。</p><p>inc/MyBuilder.pm を以下のようにかきます。</p>

    <pre class="code lang-perl">package inc::MyBuilder;
use strict;
use warnings;
use parent qw(Module::Build);

sub ACTION_test_sl {
    my $self = shift;
    $self-&gt;do_system(&#39;sl&#39;);
    $self-&gt;SUPER::ACTION_test(@_);
    $self-&gt;do_system(qw/sl -aF/);
}

1;</pre>
<p>そしたら、以下のように Build.PL をかきます。</p>

    <pre class="code lang-perl">use strict;
use warnings;
use inc::MyBuilder;

my $build = inc::MyBuilder-&gt;new(
    license              =&gt; &#39;perl&#39;,
    dynamic_config       =&gt; 0,

    build_requires       =&gt; {
        &#39;Test::More&#39; =&gt; &#39;0.98&#39;,
        &#39;Test::Requires&#39; =&gt; 0,
    },
    configure_requires   =&gt; { &#39;Module::Build&#39; =&gt; &#39;0.38&#39; },
    requires             =&gt; {
        # &#39;Exporter&#39;                      =&gt; &#39;0&#39;,
        &#39;parent&#39;                        =&gt; &#39;0&#39;,
        # &#39;Plack&#39;                         =&gt; &#39;0.9949&#39;,
    },

    no_index    =&gt; { &#39;directory&#39; =&gt; [ &#39;inc&#39; ] },
    name        =&gt; &#39;Love-Plus&#39;,
    module_name =&gt; &#39;Love::Plus&#39;,

    # script_files =&gt; [&#39;&#39;],

    test_files =&gt; (-d &#39;.git&#39; || $ENV{RELEASE_TESTING}) ? &#39;t/ xt/&#39; : &#39;t/&#39;,
    recursive_test_files =&gt; 1,
   
    create_readme  =&gt; 1,
    create_license =&gt; 1,
    create_makefile_pl =&gt; &#39;small&#39;,
);
$build-&gt;create_build_script();</pre>
<p>仕上げに以下のようにして Build script をはしらせます</p>

    <pre class="code">perl Build.PL
./Build distmeta</pre>
<p>こうすると、`make test_sl` したときに、sl コマンドが走り、その後何事もなかったかのように test が走り、test が終わるとすかさず、助けを求めながら飛んでいく機関車が走ります。<br />
「俺らはいつだって走り続ける、一秒だって止まってられねェンだ！」って感じでかっこいいですね！<br />
また、このケースでは sl コマンドが入っている必要がありますが、基本的にはインストール済みなはずなので特に問題ないでしょう。</p>

</div>
<div class="section">
    <h4>説明</h4>
    <p>さて、Module::Build ではどのように拡張していったらいいのでしょうか。</p>

<div class="section">
    <h5>perl -Ilib と同等のことをしたい。</h5>
    <p>t/lib とかは割と指定しそうです。<br />
@INC にライブラリパスをいれておくと、いいかんじに処理してくれます。</p>

    <pre class="code lang-perl">sub ACTION_test_libs {
    my $self = shift;

    local @INC = @INC;
    unshift @INC, &#34;$ENV{HOME}/perl5/acme-lib/&#34;;
    $self-&gt;SUPER::ACTION_test(@_);
}</pre>

</div>
</div>
<div class="section">
    <h4>モジュールのプリロード</h4>
    <p>perl -MFoo と同等です。あらかじめ読み込んでおきたいモジュールを指定しておくとよいですね。</p>

    <pre class="code lang-perl">sub ACTION_test_mods {
    my $self = shift;

    local $ENV{HARNESS_PERL_SWITCHES} = ($ENV{HARNESS_PERL_SWITCHES} ||&#39;&#39;) . &#39; -MAcme::FizzBuzz&#39;;

    $self-&gt;SUPER::ACTION_test(@_);
}</pre>

</div>
<div class="section">
    <h4>前処理と後処理</h4>
    <p>これについてはさきほど sl でやりましたね。</p><p>テストの開始時に memcached や MySQL を起動したり、後処理としてテンポラリーファイルをお掃除したりするような処理を書くことがありそうな感じです。</p>

<div class="section">
    <h5>テスト対象のファイル</h5>
    <p>デフォルトではないテスト対象のファイルをつかいたい場合はこんなかんじにします。</p>

    <pre class="code lang-perl">sub ACTION_test_files {
    my $self = shift;

    local $self-&gt;{properties}-&gt;{test_files} = &#39;t/*.t&#39;;

    $self-&gt;SUPER::ACTION_test(@_);
}</pre>

</div>
<div class="section">
    <h5>環境変数</h5>
    <p>普通に環境変数をさしかえれば OK です。</p>

    <pre class="code lang-perl">sub ACTION_test_env {
    my $self = shift;

    local %ENV = %ENV;
    $ENV{FOO} = &#39;BAR&#39;;

    $self-&gt;SUPER::ACTION_test(@_);
}</pre>

</div>
</div>
<div class="section">
    <h4>まとめ</h4>
    <p>テストの時にいろいろとフックしたいお！という要望から生まれたわけではないモジュールですが、なかなか重宝しています。</p><p>あと、なんかめんどくさかったらアクションをぜんぶ Perl でかけるわけなので App::Prove や TAP::Harness などを手でよんで、失敗したら die する、みたいなかんじのコードをかいちゃってもおなじことです。</p>

    <pre class="code lang-perl">sub ACTION_love {
    die &#34;Love was not found\n&#34;;
}</pre>
<p>:p</p>

</div>HASH(0x5615c092eac0)
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
