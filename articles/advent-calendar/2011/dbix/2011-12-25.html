<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="nekokak">
        <meta name="author" content="nekokak">
        <title>ラウンドロビンによる分散方法の一例 - Articles Advent Calendar 2011 Dbix</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>ラウンドロビンによる分散方法の一例</h1>

        <p>DBIx トラックの最終日となりました。<br />
当初もしかしたら一人で大方書くことになるのかガクブルしてたのですが、<br />
多くの方のご協力のもとここまでたどり着くことができ感謝感謝です。</p><br />
<p>最後はちょっと大規模よりのお話になるかもしれませんが、<br />
アイデアとして知っておいて損はないので紹介させて頂きます。</p><br />
<p>MySQLを使われている場合、master - slave構成で構築されていて、<br />
参照クエリをslaveに向けるなんてことよくやられていることかと思います。<br />
ただ単純に参照クエリをslaveに向けると<br />
<a href="http://d.hatena.ne.jp/sfujiwara/20110620/1308531677">http://d.hatena.ne.jp/sfujiwara/20110620/1308531677</a><br />
<a href="http://d.hatena.ne.jp/sfujiwara/20110621/1308625519">http://d.hatena.ne.jp/sfujiwara/20110621/1308625519</a><br />
このような問題があるので気をつけるのを前提として、<br />
master:slave = 1:3のような構成になり、参照を分散させる必要が出てきた場合のお話です。</p><br />
<p>分散方法は色々あるとおもうのですが、今回はData::WeightedRoundRobinをつかった参照分散の方法です。<br />
Data::WeightedRoundRobinは最近人気のモジュールの一つですね。xaicron++</p><p>サンプルコードはこのようになります</p>

    <pre class="code">#! perl
use strict;
use warnings;
use DBI;
use Data::WeightedRoundRobin;

my $dwr = Data::WeightedRoundRobin-&gt;new(
    [
        { value =&gt; &#39;/tmp/mysql_sandbox27774.sock&#39;, weight =&gt; 100 },
        { value =&gt; &#39;/tmp/mysql_sandbox27775.sock&#39;, weight =&gt; 100 },
    ]
);

my $dsn = &#39;dbi:mysql:test;mysql_socket=SOCKET&#39;;

for (1..10) {
    my $socket = $dwr-&gt;next;
    (my $connect_dsn = $dsn)  =~ s/SOCKET/$socket/;
    my $dbh = DBI-&gt;connect($connect_dsn,&#39;msandbox&#39;,&#39;msandbox&#39;);
    my $rows = $dbh-&gt;selectall_arrayref(&#39;SELECT * FROM user&#39;);
}</pre>
<p>今回は実験の便宜上、MySQL::Sandboxを利用してmaster : slave(2)構成をつくりました。<br />
MySQL::Sandboxについては<br />
<a href="http://d.hatena.ne.jp/ZIGOROu/20090607/1244367464">http://d.hatena.ne.jp/ZIGOROu/20090607/1244367464</a><br />
<a href="http://d.hatena.ne.jp/ZIGOROu/20090608/1244470674">http://d.hatena.ne.jp/ZIGOROu/20090608/1244470674</a><br />
こちらを参考のこと。</p><br />
<p>このようにData::WeightedRoundRobinに接続に必要な情報を設定し、<br />
都度とりだしてdbに接続することで、参照を分散させます。<br />
Data::WeightedRoundRobinはWeightedとあるように重み付けができるので、<br />
スペックの差があるdbが存在する場合なんかに（普通ないと思うけど）参照数を調節できて大変便利ですね。<br />
MySQL::Sandboxもmater:slave環境を簡単につくることができるのでとてもステキなので<br />
是非利用することをおすすめしたいです。</p>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
