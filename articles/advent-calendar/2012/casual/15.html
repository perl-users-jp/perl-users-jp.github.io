<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="yappo">
        <title>Text::Xslate TTerse の深淵なる罠 - Articles Advent Calendar 2012 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>Text::Xslate TTerse の深淵なる罠</h1>
        tag
            <a href='/tag/perl'>perl</a>
            <a href='/tag/template'>template</a>
            <a href='/tag/xslate'>xslate</a>

        <p>みなさんこんにちわ！みなさんはテンプレート使ってますね！ Xslate つかってますね！ TTerse 使ってますね！今回はうっかりハマってしまう罠を教えます！</p>

<h2>SET で作った変数はブロックスコープである</h2>

<p>ブロックスコープなんだけど SET したスコープの中にあるブロックはスコープの対象外なので以下のテストは動かなかったりするんだ。</p>

<pre><code>my $tx = Text::Xslate-&gt;new({
    syntax =&gt; 'TTerse'
});
my $ret = $tx-&gt;render_string(&lt;&lt;TMPL,);
[% SET chin = 'kiru' -%]
[% MACRO xaicron BLOCK -%]
[%   chin = 'kiranai' -%]
[%   chin -%]
[% END -%]
[% xaicron() -%]
[% chin -%]
TMPL
is $ret, "kiranaikiranai"; # kiranaikiru が帰って来て失敗する                                                                                                                                       
</code></pre>

<h2>実は SET は飾り</h2>

<p>変数の定義しなくても最初に出て来た時に SET したのと同等っぽいね。だから上のコードの xaicron マクロの中の最初の chin ってのは SET したのと同等ってわけさ。</p>

<h2>深遠な理由で例外がある</h2>

<p>色々あって次のようなケースはブロックスコープになってないんだけど、これ直しちゃうと影響範囲でかすぎるからきっとこのままっぽいね。</p>

<pre><code>my $tx = Text::Xslate-&gt;new({
    syntax =&gt; 'TTerse'
});
my $ret = $tx-&gt;render_string(&lt;&lt;TMPL,);
[% SET chin = 'kiru' -%]
[% IF 1 -%]
[%   SET chin = 'kiranai' -%]
[%   chin -%]
[% END -%]
[% chin -%]
TMPL
is $ret, "kiranaikiru"; # kiranaikiranai が帰って来て失敗する                                                                                                                                       
</code></pre>

<p>あと関係無いけどこれの ELSIF の中での chin の定義で Text::Xslate::Compiler: Cannot modify chin, which is not a lexical variable って言われるんだけど(1.6001現在)これはバグなんで gfx が直してくれるはず！</p>

<pre><code>[% IF 1 -%]
[%   SET chin = 'kiru' -%]
[% ELSIF 0 -%]
[%   SET chin = 'kiranai' -%]
[% END -%]                                                                                                                                                                                              
</code></pre>

<h2>SET つかったら負け</h2>

<p>基本的にはテンプレートでは複雑な事したら負けだし SET とかで頑張ってロジック組んじゃうとか愚か者なんだって！</p>

<blockquote class="twitter-tweet tw-align-center" lang="ja"><p>要はSETをエイリアス以外の用途で使うなってことです！ / “Text::Xslate TTerse の深淵なる罠 - Perl Advent Calendar Japan 2012 Casual Track” <a href="http://t.co/7LI2R782" title="http://htn.to/F4WZ3j">htn.to/F4WZ3j</a></p>&mdash; Fuji, Goroさん (@__gfx__) <a href="https://twitter.com/__gfx__/status/281392871024754690" data-datetime="2012-12-19T13:37:43+00:00">12月 19, 2012</a></blockquote>

<p><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>ってことで hacker track も casual track も誰か書いてくれないかなー！？</p>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
