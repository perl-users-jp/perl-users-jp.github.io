<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>カジュアルにデータを確率とか優先度で処理する - Articles Advent Calendar 2012 Casual</title>
        <meta name="title" content="カジュアルにデータを確率とか優先度で処理する - Articles Advent Calendar 2012 Casual">
        <meta name="description" content="">
        <meta name="author" content="koba04">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://perl-users.jp/articles/advent-calendar/2012/casual/3">
        <meta property="og:title" content="カジュアルにデータを確率とか優先度で処理する - Articles Advent Calendar 2012 Casual">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E3%82%AB%E3%82%B8%E3%83%A5%E3%82%A2%E3%83%AB%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%A2%BA%E7%8E%87%E3%81%A8%E3%81%8B%E5%84%AA%E5%85%88%E5%BA%A6%E3%81%A7%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:koba04,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://perl-users.jp/articles/advent-calendar/2012/casual/3">
        <meta property="twitter:title" content="カジュアルにデータを確率とか優先度で処理する - Articles Advent Calendar 2012 Casual">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://res.cloudinary.com/kfly8/image/upload/l_text:NotoSansJP-Black.otf_50_bold:%E3%82%AB%E3%82%B8%E3%83%A5%E3%82%A2%E3%83%AB%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%A2%BA%E7%8E%87%E3%81%A8%E3%81%8B%E5%84%AA%E5%85%88%E5%BA%A6%E3%81%A7%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B,co_rgb:000000,w_900,c_fit/l_text:NotoSansJP-Black.otf_30_bold:koba04,co_rgb:000000,g_south_east,x_130,y_120/v1601626948/og-perl-users-jp.png">

        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2012/casual/3">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body>
        <header class="site-header">
    <a href="/" class="logo">Perl-users.jp</a>
</header>

        <main class="entry">
        <h1 class="entry-title">カジュアルにデータを確率とか優先度で処理する</h1>
        <div class="entry-tags">
            <a class="entry-tag" href='/tag/perl'>#perl</a>
        </div>
            <div class="entry-author">koba04</div>
            <div class="entry-date">2012-12-03</div>

        <div class="entry-text">
            <p>こんにちは、こんにちは。カジュアルにPerl使っている<a href="https://twitter.com/koba04">koba04</a> です。</p><br />
<p>Webアプリを作っていて、確率で処理を分けたり複数の要素を重み付けて選びたいことってありませんか？</p><p>真っ先に浮かぶのはガチャみたいなものですが、それ以外にもランダムでバナーを出し分けてみたり、接続するサーバーを重み付けて選んだり色々と使い道が思い浮かびます。</p><br />
<p>そんな時に使える二つのモジュールをご紹介したいと思います。<br />
詳しくは下記の作者の方のブログを見てください。</p>

<ul>
<li><a href="http://unknownplace.org/memo/2012/07/17/1/">Sub::Rate</a></li>
<li><a href="http://blog.livedoor.jp/xaicron/archives/53091000.html">Data::WeightedRoundRobin</a></li>
</ul><p>以上！ でもいいのですが..順番に紹介してみたいと思います。</p><p></p>

<div class="section">
    <h4>モジュールなしで実装</h4>
    <p>優先度を付けてデータを選びたい時はrandを使っての実装が思い浮かびますが、バグりそうな気もするし面倒だし出来れば書きたくないです。<br />
(書き方が悪いという説もある)</p>

    <pre class="code prettyprint lang-perl"># 結果をdumpする関数
sub dump_total {
    my ($cb) = @_;

    my $total;
    for (1..1000) {
        my $menu = $cb-&gt;();
        if ( !exists $total-&gt;{$menu} ) {
            $total-&gt;{$menu} = 0;
        }
        ++$total-&gt;{$menu};
    }
    say Dumper $total;
}</pre>

    <pre class="code prettyprint lang-perl">my $rate = [
    { rate =&gt; 40, value =&gt; &#34;寿司&#34; },
    { rate =&gt; 20, value =&gt; &#34;ラーメン&#34; },
    { rate =&gt; 20, value =&gt; &#34;焼肉&#34; },
    { rate =&gt; 15, value =&gt; &#34;パスタ&#34; },
    { rate =&gt; 5,  value =&gt; &#34;コンビニ&#34; },
];

my $from = 0;
my $total = 0;
my $targets = [];
for my $menu ( @$rate ) {
    my $to = $from + $menu-&gt;{rate};
    push @$targets, { from =&gt; $from, to =&gt; $to, value =&gt; $menu-&gt;{value} };
    $from += $menu-&gt;{rate};
    $total += $menu-&gt;{rate};
}

my $pick = sub {
    my $num = int( rand($total) + 1 );
    for my $target ( @$targets ) {
        if ( $target-&gt;{from} &lt; $num &amp;&amp; $target-&gt;{to} &gt;= $num ) {
            return $target-&gt;{value};
        }
    }
};

say $pick-&gt;();
dump_total($pick);</pre>

    <pre class="code prettyprint">寿司
$VAR1 = {
          &#39;パスタ&#39; =&gt; 151,
          &#39;焼肉&#39; =&gt; 192,
          &#39;コンビニ&#39; =&gt; 47,
          &#39;ラーメン&#39; =&gt; 193,
          &#39;寿司&#39; =&gt; 417
        };</pre>

</div>
<div class="section">
    <h4>Sub::Rate</h4>
    <p><a href="http://search.cpan.org/~typester/Sub-Rate/">http://search.cpan.org/~typester/Sub-Rate/</a><br />
typesterさんのSub::Rateを使うと、こんな感じでmax_rateとそれぞれのrateによって関数を返してくれます。<br />
シンプルに書けてとてもいいですね。</p>

    <pre class="code prettyprint lang-perl"># default max_rate  == 100
my $rate = Sub::Rate-&gt;new;
$rate-&gt;add( 40 =&gt; sub { &#34;寿司&#34; });
$rate-&gt;add( 20 =&gt; sub { &#34;ラーメン&#34; });
$rate-&gt;add( 20 =&gt; sub { &#34;焼肉&#34; });
$rate-&gt;add( 15 =&gt; sub { &#34;パスタ&#34; });
$rate-&gt;add( default =&gt; sub { &#34;コンビニ&#34; });
my $func = $rate-&gt;generate;

say $func-&gt;();
dump_total($func);</pre>

    <pre class="code prettyprint">Sub::Rate
焼肉
$VAR1 = {
          &#39;パスタ&#39; =&gt; 153,
          &#39;焼肉&#39; =&gt; 194,
          &#39;コンビニ&#39; =&gt; 42,
          &#39;寿司&#39; =&gt; 406,
          &#39;ラーメン&#39; =&gt; 205
        };</pre>
<p><br />
またアタリ・ハズレの処理を作りたい場合もdefaultを使って簡単に出来ます。</p>

    <pre class="code prettyprint lang-perl">my $rate = Sub::Rate-&gt;new;
# 5%でよっちゃんイカがもう一個もらえる
$rate-&gt;add( 5 =&gt; sub { &#34;よっちゃんイカアタリ&#34;  });
$rate-&gt;add( default =&gt; sub { &#34;ハズレ&#34; });
my $func = $rate-&gt;generate;

say $func-&gt;();
dump_total($func);</pre>

    <pre class="code prettyprint">ハズレ
$VAR1 = {
          &#39;よっちゃんイカアタリ&#39; =&gt; 47,
          &#39;ハズレ&#39; =&gt; 953
        };</pre>
<p><br />
さらにSub::Rateではrateを決定する処理をコンストラクタで変更することも出来るので寿司がいやな人はこんなことも...</p>

    <pre class="code prettyprint lang-perl">my $rate = Sub::Rate-&gt;new(rand_func =&gt; sub {
    my ($max_rate) = @_;
    # no sushi!!!!
    return 40 + rand($max_rate);
});
$rate-&gt;add( 40 =&gt; sub { &#34;寿司&#34; });
$rate-&gt;add( 20 =&gt; sub { &#34;ラーメン&#34; });
$rate-&gt;add( 20 =&gt; sub { &#34;焼肉&#34; });
$rate-&gt;add( 15 =&gt; sub { &#34;パスタ&#34; });
$rate-&gt;add( default =&gt; sub { &#34;コンビニ&#34; });
my $func = $rate-&gt;generate;

say $func-&gt;();
dump_total($func);</pre>

    <pre class="code prettyprint">コンビニ
$VAR1 = {
          &#39;パスタ&#39; =&gt; 153,
          &#39;焼肉&#39; =&gt; 205,
          &#39;ラーメン&#39; =&gt; 196,
          &#39;コンビニ&#39; =&gt; 446
        };</pre>
<p><br />
また、モジュールにはSub::Rate::NoMaxRateというのもあってこちらだとmax_rateを計算しなくても使うことが出来ます。</p>

    <pre class="code prettyprint lang-perl"># my $rate = Sub::Rate::NoMaxRate-&gt;new(max_rate =&gt; 10000);
my $rate = Sub::Rate::NoMaxRate-&gt;new;
$rate-&gt;add( 4000 =&gt; sub { &#34;寿司&#34; });
$rate-&gt;add( 200 =&gt; sub { &#34;ラーメン&#34; });
$rate-&gt;add( 20 =&gt; sub { &#34;焼肉&#34; });
$rate-&gt;add( 10 =&gt; sub { &#34;パスタ&#34; });
$rate-&gt;add( 1 =&gt; sub { &#34;コンビニ&#34; });
my $func = $rate-&gt;generate;

say $func-&gt;();
dump_total($func);</pre>

    <pre class="code prettyprint">寿司
$VAR1 = {
          &#39;パスタ&#39; =&gt; 2,
          &#39;焼肉&#39; =&gt; 1,
          &#39;ラーメン&#39; =&gt; 54,
          &#39;寿司&#39; =&gt; 943
        };</pre>
<p><del>ただ、今のversion(0.04)だとrateの合計がmax_rate(default==100)を超えるとエラーになってしまうようなので、max_rate以上になるときは上記のようにmax_rateを予め大きくしておく必要があります。</del></p>

<ul>
<li>NoMaxRateの場合はmax_rateを意識しなくてadd出来たほうが便利かなと思ったのでpull reqしてみました。
<ul>
<li>これは0.05で修正されているのでNoMaxRateを使いたい場合は0.05以上を使うといいと思います。typesterさんありがとうございました!</li>
</ul></li>
</ul>
</div>
<div class="section">
    <h4>Data::WeightedRoundRobin</h4>
    <p><a href="http://search.cpan.org/~xaicron/Data-WeightedRoundRobin/">http://search.cpan.org/~xaicron/Data-WeightedRoundRobin/</a><br />
xaicronさんのData::WeightedRoundRobinを使うとこんな感じでそれぞれのweightによってvalueを返してくれます。(もちろん関数も返せます)</p>

    <pre class="code prettyprint lang-perl">my $dwr = Data::WeightedRoundRobin-&gt;new([
    { weight =&gt; 4, value =&gt; &#34;寿司&#34; },
    { weight =&gt; 2, value =&gt; &#34;ラーメン&#34; },
    { weight =&gt; 2, value =&gt; &#34;焼肉&#34; },
    { weight =&gt; 1.5, value =&gt; &#34;パスタ&#34; },
    { weight =&gt; 0.5, value =&gt; &#34;コンビニ&#34; },
]);

say $dwr-&gt;next;
dump_total(sub { $dwr-&gt;next });</pre>

    <pre class="code prettyprint">寿司
$VAR1 = {
          &#39;パスタ&#39; =&gt; 145,
          &#39;焼肉&#39; =&gt; 193,
          &#39;コンビニ&#39; =&gt; 53,
          &#39;ラーメン&#39; =&gt; 224,
          &#39;寿司&#39; =&gt; 385
        };</pre>
<p>こちらも簡単に書けていいですね!</p><br />
<p>どちらのモジュールを選んでも同じことが出来るのでどう使い分けるのかは好みになってくるのかなと思いますが、単純に値を返したい場合はData::WeightedRoundRobin、実行する処理を分けたい場合やハズレを作りたい場合などはSub::Rateを使うといいのかなぁとなんとなく思ったりしました。<br />
あと名前が短いのでSub::Rateとか...。</p><br />
<p>今回使ったサンプルスクリプトはこれです。<br />
<a href="https://gist.github.com/4183087">https://gist.github.com/4183087</a></p><br />
<p>こういう小粒ながら便利なモジュールはとても嬉しいですね。<br />
そして寿司もいいですね!</p><br />
<p>あしたはokamuuuさんです。楽しみですね!</p>

</div>
        </div>
        </main>
        <footer class="site-footer">
    <nav>
        <a href="https://github.com/perl-users-jp/perl-users-jp.github.io" target="_blank" rel="noopener">
            <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
    </nav>
    <p>
        <a href="/">Perl-users.jp</a> - 日本のPerlユーザーのためのハブサイトです。日本の Perl ユーザーに最新の情報を届けることを目的にしています。
    </p>
    <p>
    文章のライセンスは、特に明記が無い限りすべて <a href="http://creativecommons.org/licenses/by/2.0/">CC-by</a>でおねがいします。
    </p>
</footer>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
