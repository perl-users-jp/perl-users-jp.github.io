<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="kfly8 <kentafly88@gmail.com>">
        <meta name="author" content="kfly8 <kentafly88@gmail.com>">
        <title>こんなマジック知らなかった。 - Articles Advent Calendar 2012 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>こんなマジック知らなかった。</h1>

        <p>はじめまして。こんにちは。<a href="http://twitter.com/kfly8">kfly8</a>です。<br />
なべこたつみかんみかんみかん!黄色になった手でコードを書きます。<br />
年が明けたら熱海に温泉はっかそん行きたいです。</p><br />
<br />
<p>コードを読んでいると<br />
この処理やらなくていいんじゃないか？<br />
ってこと、よくあると思います。</p><p></p>

<div class="section">
    <h4>あるMiddlewareが変な動きをしてました</h4>
    
    <pre class="code lang-perl">
# app.psgi

use strict;
use warnings;
use utf8;

use Plack::Builder;

builder {

    # XXX 今回問題になってしまったSession周りを
    # よしなにやってくれてるMiddleware
    enable Hoge::Session =&gt; (
        session_store =&gt; Plack::Session::Store-&gt;new( ... ),
    );

    $app;
}

1;

# Hoge::Session.pm

package Hoge::Session
use strict;
use warnings;
use utf8;

sub call {
    my ( $self, $env ) = @_;

    my %options = (
        store =&gt; $self-&gt;session_store,;
    );

    # XXX ほんとによしなにやってるの？動いてないんじゃないか？
    if ( $VERY_COMPLEX_CONDITION ) {
        $options{state} = Session::State-&gt;new;
    }

    $app = Plack::Middleware::Session-&gt;wrap($app, %options);

    my $res = $app-&gt;($env);
    return $res;
}

1;
</pre>
<p><br />
<pre><br />
...<br />
$VERY_COMPLEX_CONDITION はあまりに複雑で人が追うには限界が超えていました。<br />
こんな(ニッチな)問題、、、<br />
解決しなければ、ぐっすり寝れません。<br />
</pre></p><p></p>

</div>
<div class="section">
    <h4>Variable::Magic で $env の書き込み、参照を補足</h4>
    <p>というわけで、今回紹介するモジュールは、<a href="http://search.cpan.org/~vpit/Variable-Magic-0.52/lib/Variable/Magic.pm">Variable::Magic</a>です。<br />
前置き長くてごめんなさい。<br />
(教えてくれた<a href="http://twitter.com/karupanerura">karupanerura</a>++)</p><br />
<p>$app を1枚 wrap します。</p>

    <pre class="code lang-perl">
# app.psgi

use strict;
use warnings;
use utf8;

use Plack::Builder;

builder {

    # XXX 問題のだめな子
    enable Hoge::Session =&gt; (
        session_store =&gt; Plack::Session::Store-&gt;new( ... ),
    );

    # $env のpsgix.session への書き込みと参照を補足する
    enable sub {
        my $app = shift;
        sub {
            my $env = shift;
            use Carp qw/cluck/;
            use Variable::Magic qw/wizard cast/;

            # どんなマジックを使ってやろうか定める
            my $wiz = wizard(

                # ハッシュから参照されたときに呼び出される
                fetch =&gt; sub {
                    cluck &#39;fetched!!&#39;;
                },

                # ハッシュに書き込まれたときに呼び出される
                store =&gt; sub {
                    cluck &#39;stored!!&#39;;
                },
            );

            # マジックと関連づける
            cast %{ $env-&gt;{&#39;psgix.session&#39;} }, $wiz, &#39;_default&#39;;

            return $app-&gt;($env);
        };
    };

    $app;
}
</pre>
<p>これでエラーログを見れば、書き込みと参照があったのかのびのび観測できます</p><p><pre><br />
...<br />
これで晴れて、いらんことが分かって、<br />
セッションにストアする処理が無くなりました。<br />
めでたしめでたし。<br />
</pre></p><p></p>

<blockquote >
    <p>Plack::Session が、$env->{'psgix.session'} をSession Storeに<br />
入れるシンプルな仕組みであることが効きます。<br />
もっと言えば、Plack::Middleware の仕様のおかげです。</p>

    
</blockquote>
</div>
<div class="section">
    <h4>その他の手段は</h4>
    <p>tie を使っても、同じことは実現できます。</p>

<ul>
<li><a href="http://blog.livedoor.jp/dankogai/archives/51076010.html">http://blog.livedoor.jp/dankogai/archives/51076010.html</a></li>
</ul><p>今回、package を作るのが面倒だったので、Variable::Magic を使ってみました。</p><br />
<p></p>

</div>
<div class="section">
    <h4>蛇足</h4>
    <p>ちょうどjsのadeventカレンダーでも同じような記事があったので共有します。<br />
こっちはアプリケーションで使おうって話です。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/jovi0608/20121206/1354762082">http://d.hatena.ne.jp/jovi0608/20121206/1354762082</a></li>
</ul>
</div>
<div class="section">
    <h4>まとめ</h4>
    <p>$env変数への書き込み、参照を補足して、プリントデバッグしてみましたという話でした。</p><p>明日は、Yak!さんです。お楽しみにー。</p>

</div>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
